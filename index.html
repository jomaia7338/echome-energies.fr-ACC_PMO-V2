<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACC ‚Äì P√©rim√®tre (centre libre) + Entreprises (API)</title>

  <!-- Leaflet CSS (+ fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#37C3AF">

  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:'Open Sans',system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}

    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand svg{height:26px}
    .brand .name{font-family:'Montserrat',sans-serif;font-weight:700}
    .controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:space-between;width:100%}
    .group{display:flex;align-items:center;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#fff}
    .dot{width:10px;height:10px;border-radius:50%}
    .prod{background:#6D28D9}.cons{background:#2e86de}.biz{background:#16a34a}

    .btn{padding:6px 8px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700}
    .btn.icon{min-width:36px;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:#fff;color:#0f4f47;border-color:var(--brand)}
    select,input[type="number"],input[type="text"]{border:1px solid var(--line);border-radius:8px;padding:6px 8px}

    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;font-size:14px}
    #status.ok{background:rgba(55,195,175,.08);border-color:rgba(55,195,175,.45);color:#116a60}
    #status.ko{background:#fff5f3;border-color:#f6d2cc}

    #map{min-height:420px;margin:8px;border:1px solid var(--line);border-radius:12px;position:relative}
    .legend-overlay{position:absolute;bottom:10px;left:10px;background:rgba(255,255,255,.9);border:1px solid var(--line);border-radius:8px;padding:6px 8px;display:flex;gap:10px;align-items:center;font-size:12px}
    .legend-overlay .item{display:flex;align-items:center;gap:6px}
    .leaflet-control.ratio-control{background:rgba(255,255,255,.95);border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px}

    #drawer{position:fixed;inset:auto 0 0 auto;top:0;height:100vh;width:420px;max-width:92vw;background:#fff;border-left:1px solid var(--line);box-shadow:-8px 0 24px rgba(0,0,0,.06);transform:translateX(100%);transition:.25s ease;z-index:5000;display:flex;flex-direction:column}
    #drawer.open{transform:none}
    #drawer header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    #drawer h2{font-family:'Montserrat',sans-serif;font-size:16px;margin:0}
    #drawer .content{padding:12px;overflow:auto}
    fieldset{border:1px solid var(--line);border-radius:10px;margin:10px 0;padding:10px}
    legend{padding:0 6px;color:#475569;font-size:12px}
    textarea{width:100%;min-height:80px;resize:vertical;border:1px solid var(--line);border-radius:8px;padding:8px}
    .small{font-size:12px;color:#64748b}
    .row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}

    @media (max-width: 720px){ header.slim{flex-wrap:wrap} .controls{gap:6px} }
  </style>
</head>
<body>
  <header class="slim">
    <div class="brand">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/><text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#ffffff">ECHOME</text></svg>
      <span class="name">Echome √ânergies</span>
    </div>

    <div class="controls">
      <div class="group" role="radiogroup" aria-label="Type">
        <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
        <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
      </div>

      <div class="group" aria-label="Diam√®tre">
        <label class="small">Diam√®tre :</label>
        <select id="limitSel">
          <option value="2">2 km</option>
          <option value="10">10 km</option>
          <option value="20" selected>20 km</option>
          <option value="custom">Perso</option>
        </select>
        <input id="customKm" type="number" min="0" step="0.1" placeholder="km" style="width:90px;display:none">
      </div>

      <div class="group">
        <button id="locateBtn" class="btn icon" title="Me localiser">üìç</button>
        <button id="fitBtn" class="btn icon" title="Ajuster la vue">üó∫Ô∏è</button>
        <button id="printBtn" class="btn icon" title="Imprimer">üñ®Ô∏è</button>
        <button id="clearBtn" class="btn icon" title="Effacer les participants">üóëÔ∏è</button>
        <button id="gearBtn" class="btn secondary" title="Options">‚öôÔ∏è Options</button>
      </div>
    </div>
  </header>

  <div id="status">Initialisation‚Ä¶</div>

  <div id="map" aria-label="Carte interactive">
    <div class="legend-overlay" aria-hidden="true">
      <div class="item"><span class="dot prod"></span>Producteur</div>
      <div class="item"><span class="dot cons"></span>Consommateur</div>
      <div class="item"><span class="dot biz"></span>Entreprises</div>
    </div>
  </div>

  <aside id="drawer" aria-hidden="true" aria-label="Options">
    <header>
      <h2>Options</h2>
      <button id="drawerClose" class="btn secondary">Fermer</button>
    </header>
    <div class="content">
      <fieldset>
        <legend>Projet</legend>
        <div class="row">
          <label class="small">Nom :</label>
          <input id="projName" type="text" placeholder="Projet 1" style="flex:1">
        </div>
        <div class="row" style="margin-top:6px">
          <button id="saveLocal" class="btn">Enregistrer</button>
          <select id="projList" style="flex:1"></select>
          <button id="loadLocal" class="btn secondary">Charger</button>
          <button id="delLocal" class="btn secondary">Supprimer</button>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="exportJson" class="btn">Exporter fichier</button>
          <input id="importJson" type="file" accept="application/json">
        </div>
      </fieldset>

      <fieldset>
        <legend>Import rapide</legend>
        <div class="small">Nom;Lat;Lon;Type ‚Äî Type: consumer/producer</div>
        <textarea id="bulk" placeholder="Usine A;45.76;4.84;producer&#10;Coll√®ge B;45.77;4.86;consumer"></textarea>
        <div style="margin-top:8px"><button id="importBtn" class="btn">Importer</button></div>
      </fieldset>

      <fieldset>
        <legend>Entreprises (API Annuaire)</legend>
        <div class="small">recherche-entreprises.api.gouv.fr ‚Äî sans cl√©, 25 max/page (pagination interne)</div>
        <div class="row" style="margin-top:6px">
          <label class="small">EPCI :</label>
          <input id="aeEpci" type="text" value="243801024" style="width:140px">
          <label class="small">Terme :</label>
          <input id="aeTerm" type="text" placeholder="filtre optionnel" style="flex:1;min-width:120px">
        </div>
        <div class="row" style="margin-top:6px">
          <label class="small">NAF :</label>
          <input id="aeNaf" type="text" placeholder="ex: 47.11A" style="width:120px">
          <label class="small">√âtat :</label>
          <select id="aeEtat"><option value="active" selected>active</option><option value="fermee">ferm√©e</option><option value="">(toutes)</option></select>
          <label class="small">Plafond <input id="aeSoftLimit" type="number" min="25" step="25" value="1000" style="width:90px"></label>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="aeFetch" class="btn">Charger</button>
          <button id="aeCancel" class="btn secondary">Annuler</button>
          <button id="aeShowAll" class="btn secondary">Afficher carte</button>
          <label class="small"><input id="aeInsideOnly" type="checkbox"> Seulement ‚Äúdans le p√©rim√®tre‚Äù</label>
        </div>
        <div class="row" style="margin-top:6px">
          <button id="aeExportCsvAll" class="btn">CSV (toutes)</button>
          <button id="aeExportCsvIn" class="btn secondary">CSV (dans p√©rim.)</button>
          <button id="aeExportGjAll" class="btn">GeoJSON (toutes)</button>
          <button id="aeExportGjIn" class="btn secondary">GeoJSON (dans p√©rim.)</button>
          <button id="aeClearCache" class="btn secondary">Purger cache</button>
        </div>
        <div class="small" style="margin-top:6px">√âtat : <span id="aeState">‚Äî</span></div>
      </fieldset>

      <fieldset>
        <legend>Recherche d‚Äôadresse</legend>
        <div class="row">
          <input id="searchQ" type="text" placeholder="Adresse, commune, CP" style="flex:1">
          <button id="searchBtn" class="btn">Rechercher</button>
        </div>
        <div id="searchResults" class="small" style="margin-top:6px"></div>
      </fieldset>

      <fieldset>
        <legend>Producteur par d√©faut</legend>
        <div class="small">210 Les Espinasses, 38250 Villard-de-Lans</div>
        <div style="margin-top:6px"><button id="resetDefaultBtn" class="btn secondary">R√©initialiser</button></div>
      </fieldset>

      <div class="small" style="margin-top:10px">Participants : <span id="count">Aucun point.</span></div>
    </div>
  </aside>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
  (function ensureLeaflet(cb){ if(window.L){ cb(); return; }
    var s=document.createElement('script'); s.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
    s.crossOrigin='anonymous'; s.referrerPolicy='no-referrer'; s.onload=cb;
    s.onerror=function(){ document.getElementById('status').textContent='Erreur : Leaflet bloqu√©.'; };
    document.head.appendChild(s);
  })(initApp);

  function initApp(){
    console.log('[init] start');
    const $ = id => document.getElementById(id);
    const statusEl = $('status'); const mapEl = $('map');

    // Utils
    const eps=1e-9, toRad=d=>d*Math.PI/180;
    const esc = s => String(s||'').replace(/[&<>\"']/g, c=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    const safeText = s => String(s ?? '');
    const tSet=(el,txt,cls='')=>{ el.className=cls; el.textContent=txt; };
    const hSet=(el,html,cls='')=>{ el.className=cls; el.innerHTML=html; };
    const fmtDate=(d)=>{ const p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`; };
    const haversineKm=(a,b)=>{ const R=6371, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng), lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h)); };

    // MEC
    function projectLocal(points){ const lat0=points.reduce((s,p)=>s+p.lat,0)/points.length; const lon0=points.reduce((s,p)=>s+p.lng,0)/points.length;
      const P=points.map(p=>({x:(p.lng-lon0)*111.32*Math.cos(lat0*Math.PI/180), y:(p.lat-lat0)*111.32})); return {lat0,lon0,P}; }
    const unprojectLocal=(lat0,lon0,x,y)=>({lat:lat0+y/111.32,lng:lon0+x/(111.32*Math.cos(lat0*Math.PI/180))});
    const dist2=(a,b)=>{const dx=a.x-b.x,dy=a.y-b.y;return dx*dx+dy*dy;};
    const circleBy2=(a,b)=>({x:(a.x+b.x)/2,y:(a.y+b.y)/2,r:Math.sqrt(dist2(a,b))/2});
    function circleBy3(a,b,c){ const A=b.x-a.x,B=b.y-a.y,C=c.x-a.x,D=c.y-a.y,E=A*(a.x+b.x)+B*(a.y+b.y),F=C*(a.x+c.x)+D*(a.y+c.y),G=2*(A*(c.y-b.y)-B*(c.x-b.x));
      if(Math.abs(G)<1e-12) return null; const x=(D*E-B*F)/G,y=(A*F-C*E)/G,r=Math.hypot(x-a.x,y-a.y); return {x,y,r}; }
    const inCircle=(c,p)=>Math.hypot(c.x-p.x,c.y-p.y)<=c.r+1e-9;
    function minimalEnclosingCircle(pointsLL){
      if(pointsLL.length===0) return null; if(pointsLL.length===1) return {center:pointsLL[0],r:0};
      const {lat0,lon0,P}=projectLocal(pointsLL); let best=null;
      for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++){ const c=circleBy2(P[i],P[j]); if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c; }
      for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++)for(let k=j+1;k<P.length;k++){ const c=circleBy3(P[i],P[j],P[k]); if(!c) continue; if(P.every(p=>inCircle(c,p))) if(!best||c.r<best.r) best=c; }
      if(!best){ let max=-1,a=-1,b=-1; for(let i=0;i<P.length;i++)for(let j=i+1;j<P.length;j++){ const d=dist2(P[i],P[j]); if(d>max){max=d;a=i;b=j;} } best=circleBy2(P[a],P[b]); }
      const center=unprojectLocal(lat0,lon0,best.x,best.y); return {center,r:best.r};
    }

    // Map
    const map = L.map('map',{zoomControl:true}).setView([45.3,5.6],8);
    const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'});
    const carto=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© Carto, ¬© OpenStreetMap'});
    osm.on('tileerror',()=>{ if(!map.hasLayer(carto)) carto.addTo(map); if(map.hasLayer(osm)) map.removeLayer(osm); tSet(statusEl,'Fond OSM bloqu√© ‚Üí Carto Light.'); });
    osm.addTo(map);
    L.control.scale({imperial:false,metric:true,maxWidth:120}).addTo(map);
    const RatioControl=L.Control.extend({options:{position:'topright'},onAdd(m){const d=L.DomUtil.create('div','leaflet-control ratio-control');this._d=d;this._m=m;this._u=this._u.bind(this);m.on('zoomend moveend',this._u);this._u();return d;},onRemove(m){m.off('zoomend moveend',this._u);},_u(){const c=this._m.getCenter(),z=this._m.getZoom();if(z==null){this._d.textContent='√âchelle ‚Äî';return;}const mpp=156543.03392*Math.cos(c.lat*Math.PI/180)/Math.pow(2,z);const denom=Math.max(1,Math.round(mpp/0.0002645833333));this._d.textContent='√âchelle ~ 1:'+denom.toLocaleString('fr-FR');}});
    map.whenReady(()=>map.addControl(new RatioControl()));
    function layout(){const H=document.querySelector('header.slim'),h=Math.max(420,window.innerHeight-H.getBoundingClientRect().height-16);mapEl.style.height=h+'px';try{map.invalidateSize();}catch{}}
    window.addEventListener('resize',layout); setTimeout(layout,50);

    // Data
    const participants=[]; let uid=0; let vizCircle=null;
    const colors={producer:'#6D28D9',consumer:'#2e86de',biz:'#16a34a'};
    const participantLayer=L.layerGroup().addTo(map);

    window.vizCircle=vizCircle; // keep reference consistent

    function selectedType(){ return document.querySelector('input[name="ptype"]:checked').value; }
    function currentDiameter(){ const sel=$('limitSel').value; if(sel==='custom'){ const v=parseFloat($('customKm').value||'0'); return (isNaN(v)||v<=0)?20:v; } return parseFloat(sel); }
    function updateCount(){ const n=participants.length,np=participants.filter(p=>p.type==='producer').length; $('count').textContent=n?`${n} point${n>1?'s':''} dont ${np} producteur${np>1?'s':''}.`:'Aucun point.'; }

    function addParticipant(lat,lng,type,name){
      const id=++uid, label=name||`${type} ${id}`;
      const m=L.circleMarker([lat,lng],{radius:7,color:colors[type],weight:2,fillColor:colors[type],fillOpacity:0.3}).addTo(participantLayer);
      const entry={id,name:label,type,lat,lng,marker:m};
      m.bindTooltip(`${safeText(label)} (${type})`);
      m.on('dblclick',()=>removeParticipant(id)); // suppression simple au double-clic
      participants.push(entry);
      refreshACC(true);
    }
    function removeParticipant(id){
      const i=participants.findIndex(p=>p.id===id);
      if(i>-1){ participantLayer.removeLayer(participants[i].marker); participants.splice(i,1); refreshACC(); }
    }
    map.on('click',e=> addParticipant(e.latlng.lat,e.latlng.lng,selectedType()));

    function clearVizCircle(){ if(vizCircle){ map.removeLayer(vizCircle); vizCircle=null; window.vizCircle=null; } }
    function styleParticipants(center,R){
      participants.forEach(p=>{
        const d=haversineKm(center,{lat:p.lat,lng:p.lng}), inside=d<=R+eps;
        p.marker.setStyle({ color:inside?colors[p.type]:'#8b8b8b', weight:inside?3:2, fillColor:colors[p.type], fillOpacity:inside?0.5:0.15 });
      });
    }
    function refreshACC(autoFit=false){
      updateCount();
      const D=currentDiameter(), R=D/2;
      clearVizCircle();
      if(!participants.length){ tSet(statusEl,'Ajoutez un producteur et des consommateurs.'); return; }
      if(!participants.some(p=>p.type==='producer')){ tSet(statusEl,'Aucun producteur d√©tect√©.'); return; }
      const mec=minimalEnclosingCircle(participants.map(p=>({lat:p.lat,lng:p.lng})));
      if(!mec){ tSet(statusEl,'Centre libre non calculable.'); return; }
      const pass=mec.r<=R+eps;
      vizCircle=L.circle([mec.center.lat,mec.center.lng],{radius:R*1000,color:'#6D28D9',weight:2,fill:false,opacity:0.9,dashArray:'6 6'}).addTo(map);
      window.vizCircle=vizCircle;
      styleParticipants(mec.center,R);
      if(autoFit && participants.length>1){ const g=L.featureGroup(participants.map(p=>p.marker)); map.fitBounds(g.getBounds().pad(0.25)); }
      const outside=participants.filter(p=>haversineKm(mec.center,{lat:p.lat,lng:p.lng})>R+eps).map(p=>p.name||p.type);
      if(pass){ hSet(statusEl, `<strong>Conforme</strong> ‚Äî D=${D} km ¬∑ r*=${mec.r.toFixed(2)} km ‚â§ D/2=${R.toFixed(2)} km.`,'ok'); }
      else{ hSet(statusEl, `<strong>Non conforme</strong> ‚Äî D=${D} km ¬∑ r*=${mec.r.toFixed(2)} km > D/2=${R.toFixed(2)} km ¬∑ Points limitants : ${outside.map(esc).join(', ')||'‚Äî'}`,'ko'); }
    }

    $('limitSel').addEventListener('change',e=>{ const v=e.target.value; $('customKm').style.display=(v==='custom')?'inline-block':'none'; refreshACC(); });
    $('customKm').addEventListener('input',refreshACC);
    $('clearBtn').onclick=()=>{ participants.slice().forEach(p=>removeParticipant(p.id)); };

    $('fitBtn').onclick=()=>{ if(!participants.length) return; const g=L.featureGroup(participants.map(p=>p.marker)); map.fitBounds(g.getBounds().pad(0.25)); };

    // Geoloc
    let myMarker=null, myAccCircle=null;
    function clearMyLoc(){ if(myMarker){map.removeLayer(myMarker); myMarker=null;} if(myAccCircle){map.removeLayer(myAccCircle); myAccCircle=null;} }
    $('locateBtn').addEventListener('click',()=>{
      if(!navigator.geolocation){ tSet(statusEl,'G√©olocalisation non support√©e.'); return; }
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat=pos.coords.latitude,lng=pos.coords.longitude,acc=pos.coords.accuracy||50;
        clearMyLoc();
        myMarker=L.marker([lat,lng]).addTo(map).bindTooltip('Vous √™tes ici');
        myAccCircle=L.circle([lat,lng],{radius:acc,color:'#34D399',weight:1,opacity:0.5,fillOpacity:0.06}).addTo(map);
        map.setView([lat,lng],15); tSet(statusEl,`Localis√© (~¬±${Math.round(acc)} m).`);
      },()=>tSet(statusEl,'G√©olocalisation refus√©e.'),{enableHighAccuracy:true,timeout:8000,maximumAge:30000});
    });

    // Drawer + projets
    const drawer=$('drawer');
    $('gearBtn').onclick=()=>{ refreshProjectList(); drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); };
    $('drawerClose').onclick=()=>{ drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
    const lsKey=name=>'acc_project:'+name;
    function captureState(){ return {
      name: ($('projName').value||'Projet 1').trim()||'Projet 1',
      settings: { diameterSel: $('limitSel').value, customKm: $('customKm').value },
      participants: participants.map(p=>({name:p.name,lat:p.lat,lng:p.lng,type:p.type}))
    }; }
    function applyState(st){
      participants.slice().forEach(p=>removeParticipant(p.id));
      $('projName').value=st.name||'Projet';
      $('limitSel').value=st.settings?.diameterSel||'20';
      $('customKm').value=st.settings?.customKm||'';
      $('customKm').style.display=($('limitSel').value==='custom')?'inline-block':'none';
      (st.participants||[]).forEach(p=>addParticipant(p.lat,p.lng,p.type,p.name));
      refreshACC(true);
    }
    function refreshProjectList(){ const sel=$('projList'); const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k && k.startsWith('acc_project:')) keys.push(k.slice(12)); } keys.sort(); sel.innerHTML=''; keys.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); }
    $('saveLocal').onclick=()=>{ const st=captureState(); localStorage.setItem(lsKey(st.name),JSON.stringify(st)); refreshProjectList(); tSet(statusEl,'Projet enregistr√© (local).'); };
    $('loadLocal').onclick=()=>{ const n=$('projList').value; if(!n) return; try{ const st=JSON.parse(localStorage.getItem(lsKey(n))); if(st) applyState(st); tSet(statusEl,'Projet charg√©.'); }catch{ tSet(statusEl,'Chargement impossible.'); } };
    $('delLocal').onclick=()=>{ const n=$('projList').value; if(!n) return; localStorage.removeItem(lsKey(n)); refreshProjectList(); tSet(statusEl,'Projet supprim√©.'); };
    $('exportJson').onclick=()=>{ const st=captureState(); const blob=new Blob([JSON.stringify(st,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=(st.name||'projet_acc')+'.json'; a.click(); URL.revokeObjectURL(url); };
    $('importJson').addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const st=JSON.parse(txt); applyState(st); tSet(statusEl,'Projet import√©.'); }catch{ tSet(statusEl,'Fichier invalide.'); } });

    // Impression
    function updatePrintHeader(){
      const name=($('projName').value||'Projet 1').trim()||'Projet 1';
      const D=currentDiameter(); const n=participants.length, np=participants.filter(p=>p.type==='producer').length, nc=participants.filter(p=>p.type==='consumer').length;
      // petit header optionnel : on pourrait l'ajouter si besoin
      console.log(`[print] ${name} ‚Äî D=${D} ‚Äî prod:${np} cons:${nc} total:${n}`);
    }
    async function ensureTilesReady(timeout=2000){
      return new Promise(resolve=>{
        const start=Date.now(); const tiles=[...document.querySelectorAll('.leaflet-tile')];
        if(tiles.length===0){ resolve(); return; }
        let remaining=tiles.length; const done=()=>{ if(--remaining<=0 || (Date.now()-start)>timeout) resolve(); };
        tiles.forEach(img=>{ if(img.complete && img.naturalWidth>0){ done(); } else { img.addEventListener('load',done,{once:true}); img.addEventListener('error',done,{once:true}); } });
        setTimeout(resolve, timeout);
      });
    }
    $('printBtn').onclick=async()=>{ updatePrintHeader(); try{ map.invalidateSize(); }catch{} await ensureTilesReady(1500); window.print(); };

    // Recherche adresse
    async function geocodePhoton(q){ const url='https://photon.komoot.io/api/?q='+encodeURIComponent(q)+'&lang=fr&limit=5'; const r=await fetch(url); if(!r.ok) throw new Error('Photon'); const j=await r.json(); return (j.features||[]).map(f=>{ const g=f.geometry, p=f.properties||{}; if(!g||!g.coordinates) return null; const lat=g.coordinates[1], lng=g.coordinates[0]; const label=[p.housenumber,p.street,p.name,p.city,p.postcode].filter(Boolean).join(' '); return {label: label || p.name || q, lat, lng}; }).filter(Boolean); }
    async function geocodeNominatim(q){ const url='https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&limit=5&q='+encodeURIComponent(q); const r=await fetch(url,{headers:{'Accept':'application/json'}}); if(!r.ok) throw new Error('Nominatim'); const j=await r.json(); return j.map(o=>({label:o.display_name,lat:parseFloat(o.lat),lng:parseFloat(o.lon)})); }
    async function searchAddress(q){ const box=$('searchResults'); box.textContent='Recherche‚Ä¶'; let res=[]; try{ res=await geocodePhoton(q); }catch{} if(!res.length){ try{ res=await geocodeNominatim(q); }catch{} }
      if(!res.length){ box.textContent='Aucun r√©sultat ou service indisponible.'; return; }
      const ul=document.createElement('ul'); res.forEach(r=>{ const li=document.createElement('li'); const a=document.createElement('a'); a.href='#'; a.textContent=r.label; a.dataset.lat=String(r.lat); a.dataset.lng=String(r.lng); a.dataset.label=r.label; li.appendChild(a); ul.appendChild(li); }); box.innerHTML=''; box.appendChild(ul);
    }
    $('searchBtn').addEventListener('click',()=>{ const q=($('searchQ').value||'').trim(); if(q) searchAddress(q); });
    $('searchQ').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); const q=(e.target.value||'').trim(); if(q) searchAddress(q); } });
    $('searchResults').addEventListener('click',e=>{ const a=e.target.closest('a[data-lat]'); if(!a) return; e.preventDefault(); addParticipant(parseFloat(a.dataset.lat),parseFloat(a.dataset.lng),selectedType(),a.dataset.label); map.setView([parseFloat(a.dataset.lat),parseFloat(a.dataset.lng)],15); });

    // Producteur par d√©faut
    const DEFAULT_ADDR='210 Les Espinasses, 38250 Villard-de-Lans, France';
    const DEFAULT_FALLBACK={lat:45.073, lng:5.55};
    async function geocodeDefault(addr){
      try{ const r=await fetch('https://photon.komoot.io/api/?q='+encodeURIComponent(addr)+'&lang=fr&limit=1'); if(r.ok){ const j=await r.json(); const f=j.features?.[0]; if(f) return {lat:f.geometry.coordinates[1],lng:f.geometry.coordinates[0]}; } }catch(_){}
      try{ const r=await fetch('https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&q='+encodeURIComponent(addr)); if(r.ok){ const j=await r.json(); const f=j[0]; if(f) return {lat:+f.lat,lng:+f.lon}; } }catch(_){}
      return null;
    }
    async function initDefaultProducer(){
      try{ const saved=localStorage.getItem('defaultProducer'); if(saved){ const o=JSON.parse(saved); if(o && o.lat && o.lng){ addParticipant(o.lat,o.lng,'producer',o.name||'Producteur'); tSet(statusEl,'Producteur par d√©faut charg√©.'); return; } } }catch{}
      const g=await geocodeDefault(DEFAULT_ADDR);
      if(g){ addParticipant(g.lat,g.lng,'producer','Producteur ‚Äî d√©faut'); try{ localStorage.setItem('defaultProducer',JSON.stringify({lat:g.lat,lng:g.lng,name:'Producteur ‚Äî d√©faut'})); }catch{} tSet(statusEl,'Producteur par d√©faut g√©ocod√©.'); }
      else { addParticipant(DEFAULT_FALLBACK.lat,DEFAULT_FALLBACK.lng,'producer','Producteur ‚Äî approx.'); tSet(statusEl,'Producteur par d√©faut approx.'); }
    }

    // Import participants texte
    $('importBtn').onclick=()=>{
      const txt=($('bulk').value||'').trim(); if(!txt) return;
      let ok=0,ko=0; txt.split(/\r?\n/).forEach(line=>{
        if(!line.trim()) return; const p=line.split(/[;,]|\t/).map(s=>s.trim());
        if(p.length<4){ko++;return;}
        const [name,latS,lonS,typeS]=p; const lat=+latS,lng=+lonS; if(!isFinite(lat)||!isFinite(lng)){ko++;return;}
        let t=(typeS||'').toLowerCase(); if(t.startsWith('cons')) t='consumer'; else if(t.startsWith('prod')) t='producer'; else {ko++;return;}
        addParticipant(lat,lng,t,name); ok++;
      });
      tSet(statusEl,`Import participants : ${ok} ajout√©(s), ${ko} rejet√©(s).`);
    };

    /* ==== Entreprises (API) ==== */
    const AE=(()=>{
      const st={items:[],layer:null,abort:null};
      const MAX=25, PREFIX='ae_cache_v1:';
      const keyFor=(epci,terme,naf,etat)=>`${PREFIX}${epci}|${(terme||'').trim()}|${(naf||'').trim()}|${etat||'active'}`;
      const norm=e=>{
        const lat = e.latitude ?? (Array.isArray(e.coordonnees)?e.coordonnees[0]:null);
        const lon = e.longitude ?? (Array.isArray(e.coordonnees)?e.coordonnees[1]:null);
        return {
          nom:e.nom_entreprise||e.nom||'', siren:e.siren||'', siret:e.siret||'',
          naf:e.activite_principale||'', libelle_naf:e.libelle_activite_principale||e.libelle_naf||'',
          date_creation:e.date_creation||'', adresse:e.adresse||e.adresse_ligne_1||'',
          cp:e.code_postal||'', commune:e.commune||'', epci:e.epci||'', departement:e.departement||'',
          lat:(lat!=null?+lat:null), lon:(lon!=null?+lon:null)
        };
      };
      async function fetchAll(epci,{terme='',naf='',etat='active',softLimit=1000}={}){
        if(!epci) throw new Error('EPCI requis');
        if(st.abort) st.abort.abort();
        st.abort=new AbortController();

        const k=keyFor(epci,terme,naf,etat); const cached=localStorage.getItem(k);
        if(cached){ try{ st.items=JSON.parse(cached); return {fromCache:true,total:st.items.length}; }catch{} }

        const items=[]; const seen=new Set(); let page=1;
        while(true){
          const url=new URL('https://recherche-entreprises.api.gouv.fr/search');
          url.searchParams.set('epci',epci);
          if(etat) url.searchParams.set('etat',etat);
          if(terme) url.searchParams.set('terme',terme);
          if(naf) url.searchParams.set('naf',naf);
          url.searchParams.set('per_page',String(MAX));
          url.searchParams.set('page',String(page));
          $('aeState').textContent=`Chargement page ${page}‚Ä¶`;
          const r=await fetch(url,{signal:st.abort.signal});
          if(!r.ok) throw new Error(`API ${r.status}`);
          const j=await r.json(); const batch=Array.isArray(j.results)?j.results:[];
          if(!batch.length) break;
          for(const raw of batch){
            const n=norm(raw); const key=n.siret||`${n.siren}|${n.nom}|${n.commune}`;
            if(seen.has(key)) continue; seen.add(key);
            items.push(n); if(items.length>=softLimit) break;
          }
          if(items.length>=softLimit) break;
          if(batch.length<MAX) break;
          page++; await new Promise(res=>setTimeout(res,120));
        }
        st.items=items; $('aeState').textContent=`Termin√© : ${items.length} entr√©es`;
        try{ localStorage.setItem(k,JSON.stringify(items)); }catch{}
        return {fromCache:false,total:items.length};
      }
      function ensureLayer(){ if(!st.layer){ st.layer=L.layerGroup().addTo(map); } else if(!map.hasLayer(st.layer)){ st.layer.addTo(map); } }
      function clearLayer(){ if(st.layer){ st.layer.clearLayers(); } }
      function insidePerimeter(e){
        if(!vizCircle) return false;
        const center=vizCircle.getLatLng(); const R=(vizCircle.getRadius()||0)/1000;
        if(e.lat==null||e.lon==null) return false;
        const d=haversineKm({lat:center.lat,lng:center.lng},{lat:e.lat,lng:e.lon});
        return d<=R+eps;
      }
      function addToMap({filterInside=false}={}){
        ensureLayer(); clearLayer();
        const ms=[];
        let all=0,plotted=0,inside=0;
        for(const e of st.items){
          all++; if(e.lat==null||e.lon==null) continue;
          const isIn=insidePerimeter(e); if(filterInside && !isIn) continue;
          const m=L.circleMarker([e.lat,e.lon],{radius:5,color:isIn?'#16a34a':'#1f2937',weight:2,fillColor:isIn?'#16a34a':'#374151',fillOpacity:0.35});
          const url=`https://annuaire-entreprises.data.gouv.fr/etablissement/${encodeURIComponent(e.siret||e.siren)}`;
          m.bindPopup(`<strong>${esc(e.nom)}</strong><br>${esc(e.commune||'')} ${esc(e.cp||'')}<br>NAF ${esc(e.naf||'')}${e.libelle_naf?' ‚Äì '+esc(e.libelle_naf):''}<br><a href="${url}" target="_blank" rel="noopener">Voir</a>${isIn?'<div style="color:#16a34a;margin-top:4px">Dans le p√©rim√®tre</div>':''}`);
          st.layer.addLayer(m); ms.push(m); plotted++; if(isIn) inside++;
        }
        $('aeState').textContent=`Carte : ${plotted} plac√©es (${inside} dans p√©rim.) / ${all} total`;
        if(ms.length){ const g=L.featureGroup(ms); try{ map.fitBounds(g.getBounds().pad(0.2)); }catch{} }
        return {all,plotted,inside};
      }
      function exportCSV({onlyInside=false}={}){
        const header=['nom_entreprise','siren','siret','naf','libelle_naf','date_creation','adresse','code_postal','commune','lat','lon','epci','departement','dans_perimetre'];
        const rows=st.items.map(e=>{ const inP=insidePerimeter(e); if(onlyInside && !inP) return null;
          return [e.nom,e.siren,e.siret,e.naf,e.libelle_naf,e.date_creation,e.adresse,e.cp,e.commune,e.lat,e.lon,e.epci,e.departement,inP?1:0]
            .map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(';'); }).filter(Boolean);
        const csv=[header.join(';'),...rows].join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='entreprises_epci.csv'; a.click(); URL.revokeObjectURL(a.href);
      }
      function exportGeoJSON({onlyInside=false}={}){
        const feats=st.items.map(e=>{ const inP=insidePerimeter(e); if(onlyInside && !inP) return null; if(e.lat==null||e.lon==null) return null;
          return {type:'Feature',geometry:{type:'Point',coordinates:[e.lon,e.lat]},properties:{nom_entreprise:e.nom,siren:e.siren,siret:e.siret,naf:e.naf,libelle_naf:e.libelle_naf,date_creation:e.date_creation,adresse:e.adresse,code_postal:e.cp,commune:e.commune,epci:e.epci,departement:e.departement,inside:!!inP}}; }).filter(Boolean);
        const blob=new Blob([JSON.stringify({type:'FeatureCollection',features:feats},null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='entreprises_epci.geojson'; a.click(); URL.revokeObjectURL(a.href);
      }
      function clearCache(epci,terme,naf,etat){ const k=keyFor(epci,terme,naf,etat||'active'); localStorage.removeItem(k); $('aeState').textContent='Cache vid√©'; }
      function cancel(){ if(st.abort){ st.abort.abort(); st.abort=null; $('aeState').textContent='Chargement annul√©'; } }
      return {fetchAll,addToMap,exportCSV,exportGeoJSON,clearCache,cancel};
    })();

    // AE bindings
    $('aeFetch').onclick=async()=>{
      const epci=$('aeEpci').value.trim(), terme=$('aeTerm').value.trim(), naf=$('aeNaf').value.trim(), etat=$('aeEtat').value, softLimit=Math.max(25,parseInt($('aeSoftLimit').value||'1000',10));
      $('aeState').textContent='D√©marrage‚Ä¶';
      try{ const res=await AE.fetchAll(epci,{terme,naf,etat,softLimit}); $('aeState').textContent=`${res.fromCache?'Depuis cache':'API'} : ${res.total} entr√©es`; }catch(e){ $('aeState').textContent='Erreur: '+(e.message||e); }
    };
    $('aeCancel').onclick=()=>AE.cancel();
    $('aeShowAll').onclick=()=>{ const insideOnly=$('aeInsideOnly').checked; AE.addToMap({filterInside:insideOnly}); };
    $('aeExportCsvAll').onclick=()=>AE.exportCSV({onlyInside:false});
    $('aeExportCsvIn').onclick =()=>AE.exportCSV({onlyInside:true});
    $('aeExportGjAll').onclick =()=>AE.exportGeoJSON({onlyInside:false});
    $('aeExportGjIn').onclick  =()=>AE.exportGeoJSON({onlyInside:true});
    $('aeClearCache').onclick  =()=>AE.clearCache($('aeEpci').value.trim(),$('aeTerm').value.trim(),$('aeNaf').value.trim(),$('aeEtat').value);

    // D√©marrage
    (async()=>{ try{ await initDefaultProducer(); }catch{} layout(); tSet(statusEl,'Pr√™t.'); })();

    // Diagnostics
    window.addEventListener('error', e=>{ console.error(e); tSet(statusEl,'Erreur JS : '+e.message); });
    window.addEventListener('unhandledrejection', e=>{ console.error(e); tSet(statusEl,'Erreur Promesse : '+(e.reason?.message||e.reason)); });
  }
  </script>
</body>
</html>