<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Echome √ânergies ‚Äî Outil terrain ACC/PMO</title>

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <link rel="stylesheet" href="./styles.css">
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#37C3AF">
  <link rel="icon" href="./icons/icon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
</head>
<body>
  <header>
    <h1>Echome √ânergies ¬∑ ACC/PMO ‚Äî Outil terrain</h1>
    <div id="status" class="muted">Pr√™t</div>
  </header>

  <main class="layout">
    <!-- PANNEAU OPTIONS (scrollable) -->
    <aside id="side" class="panel side-scroll">

      <div id="error-box" class="hidden"></div>

      <!-- KPIs -->
      <div class="kpis kpis-4">
        <div class="kpi"><span class="lbl">Candidats d√©tect√©s</span><b id="kpiCand">0</b></div>
        <div class="kpi"><span class="lbl">Participants</span><b id="kpiPart">0</b></div>
        <div class="kpi"><span class="lbl">Dans le rayon</span><b id="kpiRayon">0</b></div>
        <div class="kpi"><span class="lbl">Conformit√© p√©rim√®tre</span><b id="kpiLegal">‚Äî</b></div>
      </div>

      <!-- L√©gende -->
      <div class="legend">
        <span class="chip"><span class="dot prod"></span> Producteur</span>
        <span class="chip"><span class="dot cons"></span> Participant</span>
        <span class="chip"><span class="dot cand"></span> Candidat (Overpass)</span>
        <span class="pill" id="communePill">Commune: ‚Äî</span>
      </div>

      <!-- Onglets (navigation locale) -->
      <div class="seg tabs">
        <button class="seg-btn active" data-tab="tab-dossier">Dossier</button>
        <button class="seg-btn" data-tab="tab-producteur">Producteur</button>
        <button class="seg-btn" data-tab="tab-perimetre">P√©rim√®tre</button>
        <button class="seg-btn" data-tab="tab-prosp">Prospection</button>
        <button class="seg-btn" data-tab="tab-part">Participants</button>
      </div>

      <!-- TAB : DOSSIER -->
      <section id="tab-dossier" class="tab active">
        <fieldset class="fs">
          <legend>Dossier</legend>
          <div class="row">
            <div>
              <label>Nom du dossier</label>
              <input id="projectName" type="text" placeholder="Ex. Centrale ‚Äî ACC Is√®re Nord">
            </div>
            <div class="align-end">
              <button id="btnCopyLink" class="ghost">Copier le lien du dossier</button>
            </div>
          </div>
        </fieldset>
      </section>

      <!-- TAB : PRODUCTEUR -->
      <section id="tab-producteur" class="tab">
        <fieldset class="fs">
          <legend>Producteur (position de la centrale)</legend>

          <div class="row">
            <div>
              <label>Adresse (BAN)</label>
              <input id="addr" type="text" placeholder="10 rue de la R√©publique, 38000 Grenoble">
            </div>
            <div class="align-end">
              <button id="btnGeocode">G√©ocoder</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Latitude</label>
              <input id="prodLat" type="number" step="0.000001" placeholder="45.191000">
            </div>
            <div>
              <label>Longitude</label>
              <input id="prodLon" type="number" step="0.000001" placeholder="5.684000">
            </div>
          </div>

          <div class="row">
            <div class="align-end">
              <button id="btnSetProducerFromInputs" class="primary">D√©finir (coord.)</button>
            </div>
            <div class="align-end">
              <button id="btnPlaceProducer" class="ghost">Placer au clic</button>
              <button id="btnClearProducer" class="danger">Supprimer</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Centre du cercle de prospection</label>
              <div class="radio">
                <label><input type="radio" name="centreMode" value="producer" checked> Producteur</label>
                <label><input type="radio" name="centreMode" value="free"> Point libre (marqueur üîò)</label>
              </div>
            </div>
            <div class="align-end">
              <button id="btnLocate" class="ghost">üìç Me localiser</button>
            </div>
          </div>
        </fieldset>
      </section>

      <!-- TAB : P√âRIM√àTRE -->
      <section id="tab-perimetre" class="tab">
        <fieldset class="fs">
          <legend>Param√®tres de p√©rim√®tre</legend>

          <!-- Zone r√©glementaire (raccourcis) -->
          <div class="seg seg-compact" id="zoneBtns" aria-label="Zone r√©glementaire">
            <button class="seg-btn active" data-zone="STD" data-dmax="2">Standard 2 km</button>
            <button class="seg-btn" data-zone="PERI" data-dmax="10">P√©riurbain 10 km</button>
            <button class="seg-btn" data-zone="RURAL" data-dmax="20">Rural / SIS 20 km</button>
            <button class="seg-btn badge" id="btnEPCI" data-zone="EPCI" data-badge="contexte">EPCI</button>
          </div>

          <div class="row">
            <div>
              <label>Distance maximale (diam√®tre l√©gal, km)</label>
              <select id="distMaxPreset">
                <option value="2">2</option>
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="perso">Perso‚Ä¶</option>
              </select>
            </div>
            <div>
              <label>Valeur perso (km)</label>
              <input id="distMaxPerso" type="number" min="0.5" step="0.5" placeholder="Ex. 5">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Rayon de prospection (km)</label>
              <input id="distExplor" type="number" min="0.5" step="0.5" placeholder="= distance max par d√©faut">
            </div>
            <div>
              <label>R√©seau</label>
              <select id="reseau">
                <option value="BT" selected>BT</option>
                <option value="HTA">HTA</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Point libre ‚Äî Latitude / Longitude</label>
              <div class="row">
                <input id="lat" type="number" step="0.000001" placeholder="45.191000">
                <input id="lon" type="number" step="0.000001" placeholder="5.684000">
              </div>
              <div class="muted small">Astuce : d√©place le marqueur üîò directement sur la carte.</div>
            </div>
            <div class="align-end">
              <button id="btnRecentrer">Recentrer carte</button>
              <button id="btnChargerSIS" class="ghost">Charger POI SIS</button>
            </div>
          </div>

          <div class="row">
            <div>
              <button id="btnBoost20" class="seg-btn" style="width:100%">‚áß Basculer √† 20 km (usage autoris√©)</button>
            </div>
            <div class="align-end">
              <span class="muted small">Re-cliquer pour revenir √† la valeur pr√©c√©dente.</span>
            </div>
          </div>
        </fieldset>
      </section>

      <!-- TAB : PROSPECTION -->
      <section id="tab-prosp" class="tab">
        <fieldset class="fs">
          <legend>Recherche de consommateurs (Overpass)</legend>
          <div class="tags">
            <label><input type="checkbox" class="cat" value="education" checked> √âducation</label>
            <label><input type="checkbox" class="cat" value="sante" checked> Sant√©</label>
            <label><input type="checkbox" class="cat" value="adm" checked> Administrations</label>
            <label><input type="checkbox" class="cat" value="sport"> Sport</label>
            <label><input type="checkbox" class="cat" value="commerce"> Commerce</label>
            <label><input type="checkbox" class="cat" value="industrie"> Industrie l√©g√®re</label>
            <label><input type="checkbox" class="cat" value="parking"> Parkings (ombri√®re)</label>
          </div>
          <div class="row">
            <button id="btnScan">Scanner le rayon</button>
            <span class="muted small">Interroge OSM dans le rayon d√©fini (outil de prospection).</span>
          </div>
        </fieldset>
      </section>

      <!-- TAB : PARTICIPANTS -->
      <section id="tab-part" class="tab">
        <fieldset class="fs">
          <legend>Participants PMO</legend>
          <div class="row">
            <div>
              <label>Nom</label>
              <input id="partNom" type="text" placeholder="Coll√®ge Jean Moulin">
            </div>
            <div>
              <label>Lat / Lon</label>
              <div class="row">
                <input id="partLat" type="number" step="0.000001" placeholder="lat">
                <input id="partLon" type="number" step="0.000001" placeholder="lon">
              </div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Type</label>
              <select id="partType">
                <option value="consumer">Consommateur</option>
                <option value="producer">Producteur</option>
              </select>
            </div>
            <div class="align-end">
              <button id="btnAddPart" class="primary">Ajouter</button>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Importer (CSV ; Nom;Lat;Lon;consumer|producer)</label>
              <input id="fileCsv" type="file" accept=".csv,text/csv">
            </div>
            <div class="align-end">
              <button id="btnImportCsv">Importer</button>
              <button id="btnExportCsv" class="ghost">Exporter</button>
            </div>
          </div>

          <div id="listParts" class="list"></div>
        </fieldset>

        <div class="row">
          <button id="btnSaveLocal" class="primary">Enregistrer projet (local)</button>
          <div class="align-end">
            <button id="btnLoadLocal">Charger</button>
            <button id="btnDeleteLocal" class="danger">Supprimer</button>
          </div>
        </div>
      </section>
    </aside>

    <!-- CARTE (sticky) -->
    <section class="panel map-wrap">
      <div class="map-sticky">
        <div id="map"></div>
        <div class="fab" id="fabOptions" aria-label="Options">‚ò∞</div>
      </div>
    </section>
  </main>

  <script src="./app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
