<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ECHOME ¬∑ ACC ‚Äì Carte (hotfix)</title>

  <!-- Leaflet CSS (+ fallback) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root{--ink:#1c1c1c;--line:#e6eaea;--brand:#37C3AF}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--ink);background:#fff}
    header.slim{display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--line);padding:6px 8px}
    .brand{display:flex;align-items:center;gap:8px}
    .brand svg{height:26px;width:auto;border-radius:6px;box-shadow:0 0 0 1px rgba(0,0,0,.06)}
    .brand .name{font-weight:700;letter-spacing:.3px}
    .btn{padding:6px 8px;border:1px solid var(--brand);border-radius:10px;background:var(--brand);color:#fff;cursor:pointer;font-weight:700}
    #status{margin:6px 8px 0;border:1px solid var(--line);border-radius:10px;padding:8px;background:#fff;font-size:14px}
    #map{min-height:420px;margin:8px;border:1px solid var(--line);border-radius:12px}
  </style>
</head>
<body>
  <header class="slim">
    <div class="brand">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#ffffff">ECHOME</text>
      </svg>
      <span class="name">ECHOME ¬∑ ACC (hotfix carte)</span>
    </div>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <button id="fitBtn" class="btn">üó∫Ô∏è Ajuster</button>
    </div>
  </header>

  <div id="status" role="status" aria-live="polite">Initialisation‚Ä¶</div>
  <div id="map" aria-label="Carte interactive"></div>

  <!-- Leaflet JS (+ fallback) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script>
    // Si unpkg est bloqu√©, essayer cdnjs
    (function ensureLeaflet(cb){
      if(window.L){ cb(); return; }
      var s=document.createElement('script');
      s.src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js';
      s.crossOrigin='anonymous'; s.referrerPolicy='no-referrer';
      s.onload=cb;
      s.onerror=function(){ document.getElementById('status').textContent='Erreur : Leaflet bloqu√© (r√©seau).'; };
      document.head.appendChild(s);
    })(initApp);

    function initApp(){
      const statusEl = document.getElementById('status');
      const mapEl = document.getElementById('map');

      // Ajuste la hauteur de la carte (vue plein √©cran ‚Äì header ‚Äì marges)
      function layout(){
        const H=document.querySelector('header.slim');
        const h=Math.max(420, window.innerHeight - H.getBoundingClientRect().height - 16);
        mapEl.style.height = h + 'px';
        try{ map.invalidateSize(); }catch(_){}
      }

      // Cr√©e la carte
      const map = L.map('map', { zoomControl:true }).setView([45.3, 5.6], 9);

      // Fond OSM France (clair et rapide)
      const osmfr = L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© OpenStreetMap ‚Äì style OSM FR'
      });

      // Fallback Carto Light
      const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
        maxZoom: 20,
        attribution: '¬© Carto, ¬© OpenStreetMap'
      });

      osmfr.on('tileerror', ()=>{ if(!map.hasLayer(carto)) carto.addTo(map); if(map.hasLayer(osmfr)) map.removeLayer(osmfr); statusEl.textContent='Fond OSM FR indisponible ‚Üí Carto Light.'; });
      osmfr.addTo(map);

      // √âchelle m√©trique
      L.control.scale({imperial:false, metric:true, maxWidth:120}).addTo(map);

      // Bouton ajuster
      document.getElementById('fitBtn').onclick = ()=>{
        try{ map.setView([45.3,5.6], 9); }catch(_){}
      };

      // Layout dynamique
      window.addEventListener('resize', layout);
      setTimeout(layout, 30);

      statusEl.textContent = 'Carte OK. Tu peux r√©int√©grer ensuite les fonctionnalit√©s V2.';
      // Log propre des erreurs JS pour √©viter "page blanche silencieuse"
      window.addEventListener('error', e=>{ statusEl.textContent='Erreur JS : '+e.message; });
      window.addEventListener('unhandledrejection', e=>{ statusEl.textContent='Erreur Promesse : '+(e.reason?.message||e.reason); });
    }
  </script>
</body>
</html>