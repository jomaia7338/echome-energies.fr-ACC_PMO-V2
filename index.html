<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ACC ¬∑ Coordination (V2)</title>
  <meta name="theme-color" content="#37C3AF" />
  <meta name="mobile-web-app-capable" content="yes" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icon-32.png" sizes="32x32" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
  <!-- Styles -->
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#fff">ECHOME</text>
      </svg>
      <span>ACC ¬∑ Coordination</span>
    </div>

    <div class="toolbar">
      <div class="group" role="radiogroup" aria-label="Type de point">
        <label class="chip"><input type="radio" name="ptype" value="producer"> <span class="dot prod"></span>Prod.</label>
        <label class="chip"><input type="radio" name="ptype" value="consumer" checked> <span class="dot cons"></span>Cons.</label>
      </div>

      <div class="group">
        <label class="small">Diam√®tre D :</label>
        <select id="diamSel">
          <option value="2">2 km</option>
          <option value="10">10 km</option>
          <option value="20" selected>20 km</option>
          <option value="custom">Perso</option>
        </select>
        <input id="diamCustom" type="number" min="0.1" step="0.1" placeholder="km" style="width:90px;display:none">
      </div>

      <div class="group">
        <button id="btnLocate" class="btn icon" title="Me localiser">üìç</button>
        <button id="btnFit" class="btn icon" title="Ajuster la vue">üó∫Ô∏è</button>
        <button id="btnPrint" class="btn icon" title="Imprimer / PDF">üñ®Ô∏è</button>
        <button id="btnClear" class="btn icon" title="Effacer participants">üóëÔ∏è</button>
        <button id="btnDrawer" class="btn secondary">‚öôÔ∏è Options</button>
      </div>
    </div>
  </header>

  <div id="status" role="status" aria-live="polite">Initialisation‚Ä¶</div>

  <main>
    <div id="map" aria-label="Carte interactive"></div>
    <div class="legend-overlay">
      <div class="item"><span class="dot prod"></span>Producteur</div>
      <div class="item"><span class="dot cons"></span>Consommateur</div>
      <div class="item"><span class="dot poi"></span>POI incendie</div>
    </div>
  </main>

  <!-- Drawer -->
  <aside id="drawer" aria-hidden="true">
    <header>
      <h2>Options & Donn√©es</h2>
      <button id="btnDrawerClose" class="btn secondary">Fermer</button>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="tab-general">G√©n√©ral</button>
      <button class="tab" data-tab="tab-poi">POI incendie</button>
      <button class="tab" data-tab="tab-entreprises">Entreprises (EPCI)</button>
      <button class="tab" data-tab="tab-export">Exports</button>
    </div>

    <div class="content">
      <!-- G√©n√©ral -->
      <section id="tab-general" class="tab-pane active">
        <fieldset>
          <legend>Projet</legend>
          <div class="row">
            <label class="small">Nom :</label>
            <input id="projName" type="text" placeholder="Projet 1" style="flex:1">
          </div>
          <div class="row" style="margin-top:6px">
            <button id="btnSave" class="btn">Enregistrer (local)</button>
            <select id="projList" style="flex:1"></select>
            <button id="btnLoad" class="btn secondary">Charger</button>
            <button id="btnDel" class="btn secondary">Supprimer</button>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="btnExportJson" class="btn">Exporter fichier</button>
            <input id="inpImportJson" type="file" accept="application/json">
          </div>
          <div class="small" style="margin-top:6px">Participants : <span id="count">0</span></div>
        </fieldset>

        <fieldset>
          <legend>Recherche d‚Äôadresse</legend>
          <div class="row">
            <input id="qAddr" type="text" placeholder="Adresse, commune, CP" style="flex:1">
            <button id="btnSearchAddr" class="btn">Rechercher</button>
          </div>
          <div id="addrResults" class="small" style="margin-top:6px"></div>
        </fieldset>
      </section>

      <!-- POI -->
      <section id="tab-poi" class="tab-pane">
        <fieldset>
          <legend>POI incendie & secours</legend>
          <div class="small">Source OSM/Overpass ‚Äî Is√®re (fire_station). R√©essaie si surcharge.</div>
          <div class="row" style="margin-top:6px">
            <button id="btnLoadPoi38" class="btn">Charger POI Is√®re</button>
            <label class="small"><input type="checkbox" id="chkPoi" checked> Afficher</label>
            <button id="btnClearPoi" class="btn secondary">Effacer POI</button>
          </div>
          <div class="small" style="margin-top:6px">Charg√©s : <span id="poiCount">0</span> ‚Äî Dans D/2 : <span id="poiInCircle">0</span></div>
        </fieldset>
      </section>

      <!-- Entreprises -->
      <section id="tab-entreprises" class="tab-pane">
        <fieldset>
          <legend>Annuaire Entreprises (EPCI)</legend>
          <div class="small">Public API ‚Äî sans cl√©. EPCI par d√©faut : <strong>243801024</strong> (CC du Massif du Vercors).</div>
          <div class="row" style="margin-top:6px">
            <input id="epciCode" type="text" placeholder="EPCI (ex. 243801024)" value="243801024" style="width:180px">
            <button id="btnFetchEPCI" class="btn">Charger</button>
            <button id="btnCsvEPCI" class="btn secondary" disabled>Exporter CSV</button>
          </div>
          <div class="small" style="margin-top:6px">R√©sultats : <span id="epciCount">0</span> ‚Äî Pages : <span id="epciPages">0</span></div>
          <label class="small" style="display:flex;align-items:center;gap:6px;margin-top:6px">
            <input type="checkbox" id="chkFilterPerimeter" checked>
            Ne conserver que les entreprises dans le p√©rim√®tre (D/2)
          </label>
        </fieldset>
      </section>

      <!-- Exports -->
      <section id="tab-export" class="tab-pane">
        <fieldset>
          <legend>Exports</legend>
          <div class="row">
            <button id="btnCsvParticipants" class="btn">Exporter CSV participants</button>
            <button id="btnCsvPoi" class="btn">Exporter CSV POI</button>
          </div>
          <div class="row" style="margin-top:6px">
            <button id="btnGjPerimeter" class="btn secondary" disabled>Exporter GeoJSON p√©rim√®tre</button>
            <button id="btnGjPoints" class="btn secondary">Exporter GeoJSON points</button>
          </div>
        </fieldset>
      </section>
    </div>
  </aside>

  <!-- Impression -->
  <div class="print-header" id="printHeader">
    <div class="left brand">
      <svg viewBox="0 0 120 32" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <rect x="0" y="0" width="120" height="32" rx="6" fill="#37C3AF"/>
        <text x="60" y="19" text-anchor="middle" font-family="Montserrat, Arial, sans-serif" font-size="14" fill="#fff">ECHOME</text>
      </svg>
      <span class="title">ACC ¬∑ Coordination</span>
    </div>
    <div class="right small" id="printMeta"></div>
  </div>

  <!-- Leaflet JS + App -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
  <script src="app.js"></script>
</body>
</html>