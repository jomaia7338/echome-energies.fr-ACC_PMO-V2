<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Echome √ânergies ‚Äî ACC Terrain (MVP + EPCI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#11162a">
  <meta name="format-detection" content="telephone=no">
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="anonymous">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin="anonymous"></script>

  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Echome √ânergies</div>
    <div id="status" class="status">Pr√™t</div>
  </header>

  <div id="error-box" class="error-box hidden" aria-live="polite"></div>

  <main class="map-stage" role="main" aria-label="Carte ACC">
    <div id="map" class="map"></div>
  </main>

  <!-- Barre fixe (toujours visible) -->
  <nav class="btmbar" role="navigation" aria-label="Actions terrain">
    <!-- 1) Producteur -->
    <button id="btnProducer" class="btm-btn" aria-haspopup="dialog" aria-controls="sheetProducer">
      <span>Prod.</span>
    </button>

    <!-- 2) Diam√®tre (2 | 10 | 20) -->
    <div class="btm-chipset" id="chipDiameter" role="group" aria-label="Diam√®tre ACC">
      <button class="chip active" data-d="2"  aria-pressed="true">2</button>
      <button class="chip"        data-d="10" aria-pressed="false">10</button>
      <button class="chip"        data-d="20" aria-pressed="false">20</button>
    </div>

    <!-- 3) Participants -->
    <button id="btnParticipants" class="btm-btn" aria-haspopup="dialog" aria-controls="sheetParticipants">
      <span>Participants</span>
    </button>

    <!-- 3bis) EPCI -->
    <button id="btnEPCI" class="btm-btn" aria-haspopup="dialog" aria-controls="sheetEPCI">
      <span>EPCI</span>
    </button>

    <!-- 4) Conformit√© -->
    <div class="btm-badge">
      <span id="badgeCompliance" aria-live="polite">‚Äî</span>
    </div>
  </nav>

  <!-- ===== Sheet Producteur ===== -->
  <aside id="sheetProducer" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sp-title" aria-hidden="true">
    <div class="sheet-grabber" aria-hidden="true"></div>
    <header class="sheet-head">
      <h2 id="sp-title">Producteur</h2>
      <button class="sheet-close" data-close="#sheetProducer" aria-label="Fermer">‚úï</button>
    </header>

    <section class="sheet-body">
      <div class="group">
        <label for="addr" class="lbl">Adresse (BAN)</label>
        <div class="row">
          <input id="addr" type="text" inputmode="text" autocomplete="street-address"
                 placeholder="10 rue de la R√©publique, 38000 Grenoble">
          <button id="btnGeocode" class="btn primary">G√©ocoder</button>
        </div>
      </div>

      <div class="group">
        <label for="addrFull" class="lbl">Adresse postale compl√®te</label>
        <input id="addrFull" type="text" readonly placeholder="‚Äî">
      </div>

      <div class="group">
        <div class="row">
          <div>
            <label class="lbl" for="prodLat">Latitude</label>
            <input id="prodLat" type="number" inputmode="decimal" step="0.000001" placeholder="45.191000">
          </div>
          <div>
            <label class="lbl" for="prodLon">Longitude</label>
            <input id="prodLon" type="number" inputmode="decimal" step="0.000001" placeholder="5.684000">
          </div>
        </div>
        <div class="row">
          <button id="btnSetProducerFromInputs" class="btn primary">D√©finir (coord.)</button>
          <button id="btnLocate" class="btn">üìç Me localiser</button>
          <button id="btnTapSetProducer" class="btn">Poser sur carte (1-tap)</button>
        </div>
      </div>

      <div class="row right">
        <button id="btnClearProducer" class="btn danger">Supprimer le producteur</button>
      </div>
    </section>
  </aside>

  <!-- ===== Sheet Participants ===== -->
  <aside id="sheetParticipants" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sa-title" aria-hidden="true">
    <div class="sheet-grabber" aria-hidden="true"></div>
    <header class="sheet-head">
      <h2 id="sa-title">Participants</h2>
      <button class="sheet-close" data-close="#sheetParticipants" aria-label="Fermer">‚úï</button>
    </header>

    <section class="sheet-body">
      <div class="group">
        <div class="row">
          <div>
            <label class="lbl" for="partNom">Nom</label>
            <input id="partNom" type="text" placeholder="Coll√®ge Jean Moulin">
          </div>
        </div>
        <div class="row">
          <div>
            <label class="lbl" for="partLat">Latitude</label>
            <input id="partLat" type="number" inputmode="decimal" step="0.000001" placeholder="lat">
          </div>
          <div>
            <label class="lbl" for="partLon">Longitude</label>
            <input id="partLon" type="number" inputmode="decimal" step="0.000001" placeholder="lon">
          </div>
        </div>
        <div class="row">
          <div>
            <label class="lbl" for="partType">Type</label>
            <select id="partType">
              <option value="consumer">Consommateur</option>
              <option value="producer">Producteur (secondaire)</option>
            </select>
          </div>
          <div class="right">
            <button id="btnAddPart" class="btn primary">Ajouter</button>
          </div>
        </div>
      </div>

      <div class="group">
        <button id="btnAddOnMap" class="btn">Ajouter sur la carte (1-tap)</button>
      </div>

      <div class="group">
        <label class="lbl">Import CSV (Nom;Lat;Lon;Type)</label>
        <div class="row">
          <input id="fileCsv" type="file" accept=".csv,text/csv">
          <button id="btnImportCsv" class="btn">Importer</button>
          <button id="btnExportCsv" class="btn">Exporter</button>
        </div>
      </div>

      <div id="listParts" class="list" aria-live="polite"></div>
    </section>
  </aside>

  <!-- ===== Sheet EPCI ===== -->
  <aside id="sheetEPCI" class="sheet" role="dialog" aria-modal="true" aria-labelledby="se-title" aria-hidden="true">
    <div class="sheet-grabber" aria-hidden="true"></div>
    <header class="sheet-head">
      <h2 id="se-title">Mode EPCI (d√©rogatoire)</h2>
      <button class="sheet-close" data-close="#sheetEPCI" aria-label="Fermer">‚úï</button>
    </header>

    <section class="sheet-body">
      <div class="group">
        <label class="lbl">Activer le mode EPCI</label>
        <div class="row">
          <button id="btnEPCIOn"  class="btn primary">Activer</button>
          <button id="btnEPCIOff" class="btn">D√©sactiver</button>
        </div>
        <p class="small" style="color:#c6c9d1;margin:.5rem 0 0">
          En mode EPCI, la conformit√© se fait par inclusion <b>dans le polygone EPCI</b> et les <b>types autoris√©s</b>.
        </p>
      </div>

      <div class="group">
        <label class="lbl">Polygone EPCI (GeoJSON Polygon ou MultiPolygon)</label>
        <div class="row">
          <input id="fileEPCI" type="file" accept=".geojson,application/geo+json,application/json">
          <button id="btnLoadEPCI" class="btn">Charger</button>
          <button id="btnClearEPCI" class="btn danger">Vider</button>
        </div>
      </div>

      <div class="group">
        <label class="lbl">Participants autoris√©s (mode EPCI)</label>
        <div class="row">
          <select id="epciPolicy">
            <option value="public">Organismes publics / SEM / service public</option>
            <option value="any">Tous (test)</option>
          </select>
        </div>
      </div>
    </section>
  </aside>

  <script src="./app.js"></script>
</body>
</html>
