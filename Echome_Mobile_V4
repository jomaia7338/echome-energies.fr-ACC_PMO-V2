<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Echome ‚Äì Simu PV (Mobile v4)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220;--card:#111a33;--text:#e9f1fb;--muted:#9fb2cf;--brand:#0EA769;--acc:#FDB022;
    --line:rgba(255,255,255,.14);--chip:rgba(255,255,255,.08);--input:#0f1931;
  }
  @media (prefers-color-scheme: light){
    :root{--bg:#f7f9fc;--card:#fff;--text:#0f172a;--muted:#5b667d;--line:rgba(15,23,42,.12);--chip:#eef3fb;--input:#f2f6fb;}
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:560px;margin:0 auto;padding:14px 14px 100px}
  h1{font-size:1.05rem;margin:8px 0 12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;margin:10px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  label{display:block;font-size:.93rem;margin:.2rem 0}
  input,select{width:100%;padding:14px;border-radius:12px;border:1px solid var(--line);background:var(--input);color:var(--text);font-size:1rem}
  input[type=number]{appearance:textfield}
  .chip{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:var(--chip);font-size:.92rem}
  .seg{display:flex;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .seg button{flex:1;padding:12px;border:0;background:transparent;color:var(--text);font-weight:600}
  .seg button.act{background:var(--brand);color:#fff}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px}
  .kpi{padding:10px;border:1px dashed var(--line);border-radius:12px;text-align:center}
  .kpi b{display:block;font-variant-numeric:tabular-nums;margin-top:2px}
  .muted{color:var(--muted)}
  .foot{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);padding:10px env(safe-area-inset-right) calc(10px + env(safe-area-inset-bottom)) env(safe-area-inset-left)}
  .cta{width:100%;padding:16px;border-radius:12px;border:0;background:linear-gradient(180deg,var(--brand),#0b8f59);color:#fff;font-size:1.05rem;font-weight:700}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .small{font-size:.9rem}
</style>
</head>
<body>
<div class="wrap">
  <h1>üîÜ Echome ‚Äì Simu PV (Mobile v4)</h1>

  <!-- Choix du mode d'entr√©e -->
  <div class="card">
    <label class="small">Mode d‚Äôentr√©e</label>
    <div class="seg" role="tablist">
      <button class="act" id="mRoof">Toiture</button>
      <button id="mLoad">Conso</button>
      <button id="mPanels">Panneaux</button>
    </div>
    <div class="muted small" style="margin-top:6px">Choisis comment tu d√©marres : dimensions de toiture, conso annuelle, ou nb de panneaux. Les blocs se synchronisent.</div>
  </div>

  <!-- Bloc Toiture -->
  <div class="card" id="cardRoof">
    <label>Surface exploitable (m¬≤)
      <input id="s_m2" type="number" step="1" min="0" inputmode="numeric" enterkeyhint="done" placeholder="Ex. 70">
    </label>
    <div class="row muted small"><span class="chip">‚âà1,9 m¬≤/panneau</span><span class="chip">80% surface utile</span></div>
  </div>

  <!-- Bloc Conso -->
  <div class="card" id="cardLoad" style="display:none">
    <label>Consommation annuelle (kWh)
      <input id="cons" type="number" step="100" min="0" inputmode="numeric" placeholder="Ex. 6000">
    </label>
    <div class="grid2">
      <label>Objectif couverture (%)<input id="target_cov" type="number" step="5" min="50" max="120" value="100"></label>
      <label>Prix r√©seau (‚Ç¨/kWh)<input id="grid_p" type="number" step="0.01" min="0.05" value="0.25" inputmode="decimal"></label>
    </div>
  </div>

  <!-- Bloc Panneaux -->
  <div class="card" id="cardPanels" style="display:none">
    <div class="grid2">
      <label>Nombre de panneaux<input id="n_pan" type="number" step="1" min="0" inputmode="numeric" placeholder="Ex. 12"></label>
      <label>Puissance unitaire (Wc)
        <select id="mod_w"><option>350</option><option selected>400</option><option>450</option><option>500</option></select>
      </label>
    </div>
  </div>

  <!-- Site & orientation -->
  <div class="card">
    <div class="grid2">
      <label>Rendement site (kWh/kWc/an)
        <select id="yield">
          <option value="950">Nord ~950</option>
          <option value="1050">Est/Ouest ~1050</option>
          <option value="1100" selected>Moyenne ~1100</option>
          <option value="1200">Sud ~1200</option>
        </select>
      </label>
      <label>Orientation
        <select id="orient">
          <option value="S" selected>Sud</option><option value="SE">SE</option><option value="SO">SO</option>
          <option value="E">Est</option><option value="O">Ouest</option><option value="N">Nord</option>
        </select>
      </label>
    </div>
    <label>Inclinaison (¬∞)
      <select id="tilt"><option>0</option><option>10</option><option>20</option><option selected>30</option><option>35</option><option>45</option></select>
    </label>
  </div>

  <!-- Batterie / MyLight -->
  <div class="card">
    <div class="seg" style="margin-bottom:8px">
      <button id="battOff" class="act">Sans batterie</button>
      <button id="battOn">Avec batterie</button>
    </div>
    <label>Gain si batterie (%)<input id="virt_add" type="number" step="1" min="0" max="60" value="30"></label>
    <div class="row">
      <label class="row" style="gap:8px"><input type="checkbox" id="isVirtual" checked> <span>MyLight150 (prime non √©ligible)</span></label>
      <label style="flex:1">Abonnement (‚Ç¨/mois)<input id="sub_m" type="number" min="0" step="1" value="15"></label>
    </div>
    <label>Autoconsommation de base sans batterie (%)<input id="ac_base" type="number" step="1" min="5" max="95" value="40"></label>
  </div>

  <!-- R√©sultats rapides -->
  <div class="card">
    <div class="kpis">
      <div class="kpi">kWc pr√©vu<b id="k_kwc">‚Äî</b></div>
      <div class="kpi">Productible/an<b id="k_prod">‚Äî</b></div>
      <div class="kpi">Autoconsommation<b id="k_ac">‚Äî</b></div>
      <div class="kpi">Surplus<b id="k_sur">‚Äî</b></div>
      <div class="kpi">√âconomies/an<b id="k_sav">‚Äî</b></div>
      <div class="kpi">Gain net/an<b id="k_net">‚Äî</b></div>
    </div>
    <div class="muted small" id="brief">‚Äî</div>
  </div>

  <!-- Aides -->
  <div class="card">
    <label>P√©riode bar√®mes (CRE/OA)
      <select id="period">
        <option value="2025T2">2025 T2</option>
        <option value="2025T3" selected>2025 T3</option>
      </select>
    </label>
    <label>Contrat OA
      <select id="contract"><option value="surplus" selected>Autoconsommation + surplus</option><option value="totale">Vente totale (‚â•9 kWc)</option></select>
    </label>
    <div class="kpis" style="margin-top:8px">
      <div class="kpi">Prime<b id="k_prime">‚Äî</b></div>
      <div class="kpi">Tarif OA<b id="k_oa">‚Äî</b></div>
      <div class="kpi">Revente/an<b id="k_rev">‚Äî</b></div>
      <div class="kpi">Net (incl. OA)<b id="k_allnet">‚Äî</b></div>
    </div>
    <div class="muted small">Prime uniquement si contrat ‚Äúsurplus‚Äù **et** sans batterie virtuelle coch√©e.</div>
  </div>
</div>

<!-- Barre d‚Äôaction -->
<div class="foot"><button class="cta" id="calcBtn">Calculer</button></div>

<script>
/* Utilitaires */
const PANEL_M2=1.9, FILL=0.8;
const $=id=>document.getElementById(id);
const n=v=>{const x=parseFloat(String(v).replace(',','.'));return isFinite(x)?x:0}
const euro=x=> (x||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
const rate=x=> (x||0).toLocaleString('fr-FR',{minimumFractionDigits:3,maximumFractionDigits:4})+' ‚Ç¨/kWh';

/* Modes d‚Äôentr√©e (tabs) */
const tabs={mRoof:$('mRoof'),mLoad:$('mLoad'),mPanels:$('mPanels')};
const cards={cardRoof:$('cardRoof'),cardLoad:$('cardLoad'),cardPanels:$('cardPanels')};
Object.values(tabs).forEach(b=>b.addEventListener('click',()=>switchMode(b.id)));
function switchMode(id){
  Object.values(tabs).forEach(b=>b.classList.remove('act'));
  tabs[id].classList.add('act');
  cards.cardRoof.style.display= (id==='mRoof')?'block':'none';
  cards.cardLoad.style.display= (id==='mLoad')?'block':'none';
  cards.cardPanels.style.display=(id==='mPanels')?'block':'none';
}

/* Orientation / inclinaison ‚Üí facteur */
function oriTiltFactor(o,t){
  let f=1; if(o==='SE'||o==='SO') f=.95; else if(o==='E'||o==='O') f=.88; else if(o==='N') f=.65;
  let g=1; t=n(t)||30; if(t===0)g=.93; else if(t<=10)g=.96; else if(t<=20)g=.98; else if(t<=30)g=1; else if(t<=35)g=.99; else if(t<=45)g=.95; else g=.9;
  return f*g;
}

/* Synchros entr√©e */
let lock=false;
function panelsFromSurface(m2){return Math.max(0,Math.floor(Math.max(0,n(m2))*FILL/PANEL_M2))}
function surfaceFromPanels(nb){return Math.ceil(Math.max(0,Math.floor(n(nb)))*PANEL_M2/FILL)}
function syncFromSurface(){ if(lock) return; lock=true; $('n_pan').value=panelsFromSurface($('s_m2').value); lock=false; }
function syncFromPanels(){ if(lock) return; lock=true; $('s_m2').value=surfaceFromPanels($('n_pan').value); lock=false; }
$('s_m2').addEventListener('input',syncFromSurface);
$('n_pan').addEventListener('input',syncFromPanels);

/* Batterie */
let batteryOn=false;
$('battOff').onclick=()=>{batteryOn=false;$('battOff').classList.add('act');$('battOn').classList.remove('act');}
$('battOn').onclick =()=>{batteryOn=true; $('battOn').classList.add('act'); $('battOff').classList.remove('act');}

/* Bar√®mes officiels T2/T3 2025 (identiques ici) */
const RATES={
  "2025T2":{prime:{p9:80,p36:180,p100:90},surplus:{s9:0.040,s100:0.0731},totale:{v36:0.1243,v100:0.1081}},
  "2025T3":{prime:{p9:80,p36:180,p100:90},surplus:{s9:0.040,s100:0.0731},totale:{v36:0.1243,v100:0.1081}}
};
const curRates = ()=>RATES[$('period').value];
const primeRate=(kwc,r)=> kwc<=9?r.prime.p9: kwc<=36?r.prime.p36: kwc<=100?r.prime.p100:0;
const oaTarif=(kwc,mode,r)=> mode==='surplus' ? (kwc<=9?r.surplus.s9: kwc<=100?r.surplus.s100:0)
                                           : (kwc<9?0: kwc<=36?r.totale.v36: kwc<=100?r.totale.v100:0);

/* Calcul c≈ìur */
function compute(){
  // √âtape 1 : d√©terminer nb panneaux et surface selon le mode
  let nb = Math.max(0, Math.floor(n($('n_pan').value)));
  let m2 = Math.max(0, n($('s_m2').value));
  const modW=Math.max(200,n($('mod_w').value||400));

  const modeActive = document.querySelector('.seg button.act').id;
  if(modeActive==='mRoof' && m2>0){ nb = panelsFromSurface(m2); $('n_pan').value=nb; }
  if(modeActive==='mPanels' && nb>0){ m2 = surfaceFromPanels(nb); $('s_m2').value=m2; }
  // mLoad (Conso) est trait√© en sizing direct si conso>0
  const conso = Math.max(0,n($('cons').value));
  const coverage = Math.max(0.5,Math.min(1.2,n($('target_cov').value)/100));
  const yield0 = Math.max(500,n($('yield').value));
  const factor = oriTiltFactor($('orient').value,$('tilt').value);

  if(modeActive==='mLoad' && conso>0){
    const kwc_need = (conso*coverage)/(yield0*factor);
    nb = Math.max(1, Math.round((kwc_need*1000)/modW));
    m2 = surfaceFromPanels(nb);
    $('n_pan').value=nb; $('s_m2').value=m2;
  }

  // √âtape 2 : kWc / productible
  const kwc = (nb*modW)/1000;
  const prod = Math.round(kwc*yield0*factor);

  // √âtape 3 : autoconsommation
  let ac = Math.max(0,Math.min(100,n($('ac_base').value)||40));
  if(batteryOn) ac = Math.min(95, ac + (n($('virt_add').value)||0));
  if(prod>0 && conso>0) ac = Math.min(ac, Math.round(Math.min(100,(conso/prod)*100)));
  const surplusPct = Math.max(0,100-ac);

  // √âtape 4 : √©conomies, mylight
  const gridP = Math.max(0.05,n($('grid_p').value)||0.25);
  const savings = (prod * (ac/100)) * gridP;
  const subYear = ($('isVirtual').checked? Math.max(0,n($('sub_m').value))*12 : 0);
  const net = savings - subYear;

  // √âtape 5 : aides / OA
  const r = curRates();
  const modeOA = $('contract').value;
  const t = oaTarif(kwc,modeOA,r);
  const isVirtual = $('isVirtual').checked;
  const prime = (modeOA==='surplus' && !isVirtual) ? Math.round(primeRate(kwc,r)*kwc) : 0;
  const rev = t>0 ? (modeOA==='surplus' ? (prod*(surplusPct/100))*t : prod*t) : 0;
  const allNet = net + rev;

  // Affichage
  $('k_kwc').textContent = kwc? kwc.toFixed(1)+' kWc':'‚Äî';
  $('k_prod').textContent= prod? prod.toLocaleString('fr-FR')+' kWh':'‚Äî';
  $('k_ac').textContent  = ac? ac+' %':'‚Äî';
  $('k_sur').textContent = surplusPct? surplusPct+' %':'‚Äî';
  $('k_sav').textContent = euro(savings)+'/an';
  $('k_net').textContent = euro(net)+'/an';
  $('k_prime').textContent= prime? euro(prime):'‚Äî';
  $('k_oa').textContent   = t? rate(t) : (modeOA==='totale' && kwc<9 ? 'Non √©ligible':'‚Äî');
  $('k_rev').textContent  = rev? euro(rev)+'/an':'‚Äî';
  $('k_allnet').textContent = euro(allNet)+'/an';

  $('brief').textContent = kwc
    ? `‚âà ${nb} panneaux ${modW} Wc ‚Ä¢ ${m2} m¬≤ ‚Ä¢ facteur site ${factor.toFixed(2)} ‚Ä¢ ${modeOA==='surplus'?'vente de surplus ':'vente totale '}${t?rate(t):'‚Äî'}`
    : 'Renseigne toiture, conso ou panneaux.';
}

$('calcBtn').addEventListener('click',compute);
// recalculs fluides (sans spam)
['s_m2','n_pan','mod_w','yield','orient','tilt','cons','target_cov','grid_p','ac_base','virt_add','sub_m','isVirtual','period','contract']
  .forEach(id=>$(id).addEventListener('change',compute));
</script>
</body>
</html>