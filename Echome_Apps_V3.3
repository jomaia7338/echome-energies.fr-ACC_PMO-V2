<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Echome Simulateur √ânergie ‚Äî v3.4 (CRE fig√©)</title>
<meta name="color-scheme" content="light dark">
<style>
  :root{
    --bg:#0b1220; --panel:#0e162a; --card:#101a33; --text:#e9f1fb; --muted:#9fb2cf;
    --accent:#FDB022; --brand:#0EA769; --border:rgba(255,255,255,.12);
    --shadow:0 10px 30px rgba(0,0,0,.35); --table-alt:rgba(255,255,255,.04);
    --chip:rgba(255,255,255,.06); --input:#0f1a31; --radius:16px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f6f8fb; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#5b667d;
      --accent:#e69400; --brand:#0EA769; --border:rgba(15,23,42,.12); --shadow:0 10px 24px rgba(2,6,23,.08);
      --table-alt:rgba(2,6,23,.03); --chip:#f3f6fb; --input:#f7f9fd; }
  }
  [data-theme="light"]{ --bg:#f6f8fb; --panel:#ffffff; --card:#ffffff; --text:#0f172a; --muted:#5b667d; --accent:#e69400; --brand:#0EA769; --border:rgba(15,23,42,.12); --shadow:0 10px 24px rgba(2,6,23,.08); --table-alt:rgba(2,6,23,.03); --chip:#eef3fb; --input:#f7f9fd; }
  [data-theme="dark"]{ --bg:#0b1220; --panel:#0e162a; --card:#101a33; --text:#e9f1fb; --muted:#9fb2cf; --accent:#FDB022; --brand:#0EA769; --border:rgba(255,255,255,.12); --shadow:0 10px 30px rgba(0,0,0,.35); --table-alt:rgba(255,255,255,.04); --chip:rgba(255,255,255,.06); --input:#0f1a31; }

  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1120px;margin:0 auto;padding:24px 16px 80px}
  header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px;border:1px solid var(--border);border-radius:var(--radius);background:linear-gradient(180deg,var(--table-alt),transparent);box-shadow:var(--shadow)}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:40px;height:40px;border-radius:12px;display:grid;place-items:center;border:1px solid var(--border);background:linear-gradient(135deg,#0d1726,#18314f)}
  .logo strong{color:var(--accent)}
  .h1{margin:0;font-size:1.25rem}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,var(--table-alt),transparent);cursor:pointer;color:var(--text);text-decoration:none}
  .primary{background:linear-gradient(180deg,var(--brand),#0b8f59);color:#fff;border-color:transparent}
  .ghost{background:transparent}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;background:var(--chip)}
  .toggle{display:inline-flex;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .toggle button{border:0;padding:8px 12px;background:transparent;color:var(--text);cursor:pointer}
  .toggle button.active{background:var(--brand);color:white}
  .grid{display:grid;gap:16px}
  @media(min-width:960px){.cols-2{grid-template-columns:1fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr}}
  section{margin:16px 0;padding:16px;border:1px solid var(--border);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
  h2{margin:.2rem 0 .8rem 0;font-size:1.1rem} h3{margin:.2rem 0 .6rem 0;font-size:1rem}
  label{display:block;margin:.35rem 0}
  input, select{width:100%;padding:.6rem .7rem;border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--text);font-size:1rem}
  .kbd{font-family:ui-monospace,Menlo,Consolas;padding:.15rem .45rem;border-radius:6px;background:var(--table-alt);border:1px solid var(--border)}
  .result{padding:10px;border-left:4px solid var(--brand);background:linear-gradient(180deg,var(--table-alt),transparent);border-radius:12px}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
  th{background:var(--table-alt)}
  .kpi{display:flex;justify-content:space-between;gap:8px;padding:10px;border:1px dashed var(--border);border-radius:12px;background:linear-gradient(180deg,var(--table-alt),transparent);font-variant-numeric:tabular-nums}
  .kpi b{font-size:1.15rem}
  .note{border-left:4px solid var(--accent);padding-left:12px;color:var(--muted)}
  .stepper{display:inline-flex;gap:6px;align-items:center}
  .stepper button{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--table-alt);cursor:pointer}
  footer{margin-top:20px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap" id="root" data-theme="light">
  <header>
    <div class="brand">
      <div class="logo"><strong>EC</strong></div>
      <div>
        <div class="h1">Echome Simulateur √ânergie ‚Äî v3.4</div>
        <div class="muted">PV : √©quipement ‚Ä¢ conso/autoconsommation ‚Ä¢ aides ‚Ä¢ dimensionnement conso ‚Ä¢ MyLight150</div>
      </div>
    </div>
    <div class="row">
      <button id="theme" class="btn" type="button">‚òÄÔ∏è Th√®me</button>
      <button id="print" class="btn" type="button">üßæ Export PDF</button>
      <span class="pill">
        Batterie :
        <span class="toggle" role="tablist" aria-label="Avec/Sans batterie">
          <button id="battOff" class="active" role="tab" aria-selected="true">Sans</button>
          <button id="battOn" role="tab" aria-selected="false">Avec</button>
        </span>
      </span>
    </div>
  </header>

  <!-- √âQUIPEMENT PV -->
  <section id="equip">
    <h2>üîÜ Bloc √âquipement PV</h2>
    <div class="grid cols-3">
      <div>
        <label>Surface exploitable (m¬≤)
          <div class="stepper">
            <button type="button" onclick="step('s_m2',-1)">‚Äì</button>
            <input id="s_m2" type="number" min="0" step="1" value="60" inputmode="numeric">
            <button type="button" onclick="step('s_m2',1)">+</button>
          </div>
        </label>
        <div class="muted">Auto-calcul du nombre de panneaux (‚âà 1,9 m¬≤/panneau, 80 % de surface utile)</div>
        <label>Nombre de panneaux (laisser vide ‚Üí auto)
          <div class="stepper">
            <button type="button" onclick="step('n_pan',-1)">‚Äì</button>
            <input id="n_pan" type="number" min="0" step="1" value="0" inputmode="numeric">
            <button type="button" onclick="step('n_pan',1)">+</button>
          </div>
        </label>
        <label>Puissance unitaire
          <select id="mod_w"><option>350</option><option selected>400</option><option>450</option><option>500</option></select> Wc
        </label>
      </div>
      <div>
        <label>Orientation
          <select id="orient"><option value="S" selected>Sud</option><option value="SE">Sud-Est</option><option value="SO">Sud-Ouest</option><option value="E">Est</option><option value="O">Ouest</option><option value="N">Nord</option></select>
        </label>
        <label>Inclinaison (¬∞)
          <select id="tilt"><option>0</option><option>10</option><option>20</option><option selected>30</option><option>35</option><option>45</option></select>
        </label>
        <label>Rendement site ‚Äî moyenne nationale (kWh/kWc/an)
          <input id="yield" type="number" step="10" value="1100" inputmode="decimal">
          <div class="row" style="margin-top:6px">
            <span class="pill" onclick="setYield(950)">Nord 950</span>
            <span class="pill" onclick="setYield(1050)">E/O 1050</span>
            <span class="pill" onclick="setYield(1200)">Sud 1200</span>
          </div>
        </label>
      </div>
      <div class="row">
        <button class="primary btn" type="button" onclick="calcAll()">Calculer</button>
        <button class="btn ghost" type="button" onclick="resetForm()">R√©initialiser</button>
        <span id="equip_out" class="result" style="flex:1">‚Äî</span>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:10px">
      <div class="kpi"><span>Puissance cr√™te</span><b id="kpi_kwc">‚Äî kWc</b></div>
      <div class="kpi"><span>Productible (annuel)</span><b id="kpi_prod">‚Äî kWh</b></div>
      <div class="kpi"><span>Surplus (apr√®s batterie)</span><b id="kpi_surplus">‚Äî %</b></div>
    </div>
  </section>

  <!-- CONSOMMATION / AUTOCONSOMMATION -->
  <section id="conso">
    <h2>‚ö° Bloc Consommation & Autoconsommation</h2>
    <div class="grid cols-3">
      <div>
        <label>Consommation annuelle client (kWh) <input id="cons" type="number" step="100" value="6000" inputmode="numeric"></label>
        <label>Autoconsommation de base (%) ‚Äî sans batterie <input id="ac_base" type="number" min="5" max="95" step="1" value="40" inputmode="numeric"></label>
      </div>
      <div>
        <label>Gain d'autoconsommation si batterie (%) <input id="virt_add" type="number" min="0" max="60" step="1" value="30" inputmode="numeric"></label>
        <label>Prix d'achat r√©seau (‚Ç¨/kWh) <input id="grid_p" type="number" min="0.05" step="0.01" value="0.25" inputmode="decimal"></label>
        <div class="row" style="margin-top:6px">
          <label style="display:flex;gap:8px;align-items:center">
            <input type="checkbox" id="isVirtual" checked> Batterie virtuelle MyLight150 (prime non √©ligible)
          </label>
          <label style="flex:1">Abonnement MyLight150 (‚Ç¨/mois) <input id="sub_m" type="number" min="0" step="1" value="15"></label>
        </div>
      </div>
      <div>
        <h3>Dimensionnement par consommation</h3>
        <label>Objectif de couverture conso (%) <input id="target_cov" type="number" min="50" max="120" step="5" value="100"></label>
        <button class="btn primary" type="button" onclick="sizeFromConsumption()">D√©terminer le kit</button>
        <div id="size_out" class="result" style="margin-top:8px">‚Äî</div>
      </div>
    </div>
    <div class="grid cols-3" style="margin-top:10px">
      <div class="kpi"><span>Autoconsommation estim√©e</span><b id="kpi_ac">‚Äî %</b></div>
      <div class="kpi"><span>√âconomies d'achat r√©seau</span><b id="kpi_sav">‚Äî ‚Ç¨/an</b></div>
      <div class="kpi"><span>Gain net (apr√®s abonnement)</span><b id="kpi_net">‚Äî ‚Ç¨/an</b></div>
    </div>
  </section>

  <!-- AIDES -->
  <section id="aides">
    <h2>üí∂ Bloc Aides & Tarifs</h2>
    <div class="grid cols-3">
      <div>
        <label>P√©riode bar√®mes
          <select id="period" onchange="renderMemo();calcAides()">
            <option value="2025T2">2025 T2 (28/03 ‚Üí 30/06)</option>
            <option value="2025T3" selected>2025 T3 (01/07 ‚Üí 30/09)</option>
            <option value="custom">Personnalis√©e‚Ä¶</option>
          </select>
        </label>
        <div id="customBox" style="display:none">
          <h3 style="margin:.6rem 0 .2rem">Bar√®mes personnalis√©s</h3>
          <div class="grid cols-2">
            <label>Prime ‚â§9 (‚Ç¨/kWc) <input id="c_p9" type="number" step="1" value="80"></label>
            <label>Prime 9‚Äì36 <input id="c_p36" type="number" step="1" value="180"></label>
            <label>Prime 36‚Äì100 <input id="c_p100" type="number" step="1" value="90"></label>
            <label>Surplus ‚â§9 (‚Ç¨/kWh) <input id="c_s9" type="number" step="0.001" value="0.040"></label>
            <label>Surplus 9‚Äì100 <input id="c_s100" type="number" step="0.001" value="0.0731"></label>
            <label>Vente totale 9‚Äì36 <input id="c_v36" type="number" step="0.001" value="0.1243"></label>
            <label>Vente totale 36‚Äì100 <input id="c_v100" type="number" step="0.001" value="0.1081"></label>
          </div>
        </div>
      </div>
      <div>
        <label>Type de contrat OA
          <select id="contract" onchange="calcAides()">
            <option value="surplus" selected>Autoconsommation + vente de surplus</option>
            <option value="totale">Vente totale (‚â• 9 kWc)</option>
          </select>
        </label>
        <div class="muted">‚ö†Ô∏è Prime autoconsommation uniquement si <b>surplus</b> et <b>sans batterie virtuelle</b>.</div>
      </div>
      <div class="row">
        <button class="btn primary" type="button" onclick="calcAides()">Calcul aides</button>
        <span id="aides_out" class="result" style="flex:1">‚Äî</span>
      </div>
    </div>

    <div class="grid cols-3" style="margin-top:10px">
      <div class="kpi"><span>Tarif OA</span><b id="kpi_oa">‚Äî ‚Ç¨/kWh</b></div>
      <div class="kpi"><span>Prime d'installation</span><b id="kpi_prime">‚Äî ‚Ç¨</b></div>
      <div class="kpi"><span>Revente annuelle (OA)</span><b id="kpi_rev">‚Äî ‚Ç¨/an</b></div>
    </div>

    <table id="primeSched" style="margin-top:10px;display:none">
      <thead><tr><th>√âch√©ance</th><th class="right">Montant</th></tr></thead>
      <tbody></tbody>
    </table>

    <section>
      <h3>M√©mo des tarifs (p√©riode s√©lectionn√©e)</h3>
      <table>
        <thead><tr><th>Contrat</th><th>Palier</th><th>Tarif / Prime</th></tr></thead>
        <tbody id="memoBody"></tbody>
      </table>
      <p class="note">Bar√®mes officiels fig√©s : 2025 T2 & T3 (CRE / OA). Utiliser ‚ÄúPersonnalis√©e‚Äù pour T1 2025 ou 2024.</p>
    </section>
  </section>

  <footer>¬© 2025 Echome Energies ‚Äî Prototype local (aucune donn√©e envoy√©e) ‚Ä¢ <span class="kbd">Ctrl/Cmd+S</span> pour garder ce fichier.</footer>
</div>

<script>
/* --- Th√®me & impression --- */
(function initTheme(){
  const root = document.documentElement;
  const saved = localStorage.getItem('ee-theme');
  if(saved) root.setAttribute('data-theme', saved);
  document.getElementById('theme').addEventListener('click', ()=>{
    const cur = root.getAttribute('data-theme') || 'system';
    const next = cur==='light' ? 'dark' : (cur==='dark' ? 'system' : 'light');
    root.setAttribute('data-theme', next);
    localStorage.setItem('ee-theme', next);
    document.getElementById('theme').textContent = (next==='dark'?'üåô':next==='light'?'‚òÄÔ∏è':'üñ•Ô∏è') + ' Th√®me';
  });
})();
document.getElementById('print').addEventListener('click', ()=>window.print());

/* Batterie on/off */
let batteryOn = false;
document.getElementById('battOff').addEventListener('click', ()=>setBattery(false));
document.getElementById('battOn').addEventListener('click', ()=>setBattery(true));
function setBattery(on){
  batteryOn = on;
  document.getElementById('battOff').classList.toggle('active', !on);
  document.getElementById('battOn').classList.toggle('active', on);
  calcAll();
}

/* Helpers */
function num(v){ const x=parseFloat(String(v).replace(',','.')); return isFinite(x)?x:0; }
function euro(n){ return (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}); }
function rate(n){ return (n||0).toLocaleString('fr-FR',{minimumFractionDigits:3,maximumFractionDigits:4})+' ‚Ç¨/kWh'; }
function step(id,delta){
  const el=document.getElementById(id);
  el.stepUp(delta>0?1:-1);
  if(id==='s_m2') syncFromSurface();
  else if(id==='n_pan') syncFromPanels();
  else calcAll();
}

/* Orientation / inclinaison */
function oriTiltFactor(o,t){
  let f_ori=1; if(o==='SE'||o==='SO') f_ori=.95; else if(o==='E'||o==='O') f_ori=.88; else if(o==='N') f_ori=.65;
  let f_t=1; t=num(t)||30;
  if(t===0) f_t=.93; else if(t<=10) f_t=.96; else if(t<=20) f_t=.98; else if(t<=30) f_t=1; else if(t<=35) f_t=.99; else if(t<=45) f_t=.95; else f_t=.9;
  return f_ori*f_t;
}

/* Surface <-> Panneaux */
const PANEL_M2 = 1.9;  // m¬≤ / panneau
const FILL     = 0.8;  // 80 % d'occupation
function panelsFromSurface(m2){ const usable=Math.max(0,num(m2))*FILL; return Math.max(0, Math.floor(usable/PANEL_M2)); }
function surfaceFromPanels(n){ const p=Math.max(0,Math.floor(num(n))); return Math.ceil((p*PANEL_M2)/FILL); }

let _syncLock=false;
function syncFromSurface(){
  if(_syncLock) return; _syncLock=true;
  const n=panelsFromSurface(document.getElementById('s_m2').value);
  document.getElementById('n_pan').value=n;
  _syncLock=false; calcAll();
}
function syncFromPanels(){
  if(_syncLock) return; _syncLock=true;
  const m2=surfaceFromPanels(document.getElementById('n_pan').value);
  document.getElementById('s_m2').value=m2;
  _syncLock=false; calcAll();
}
document.getElementById('s_m2').addEventListener('input', syncFromSurface);
document.getElementById('n_pan').addEventListener('input', syncFromPanels);

/* Calcul √âquipement */
function calcEquip(){
  const n     = num(document.getElementById('n_pan').value);
  const modW  = num(document.getElementById('mod_w').value);
  const m2    = num(document.getElementById('s_m2').value);
  const kwc   = (n * modW) / 1000;
  const prod  = Math.round(
    kwc *
    num(document.getElementById('yield').value) *
    oriTiltFactor(document.getElementById('orient').value, document.getElementById('tilt').value)
  );
  document.getElementById('kpi_kwc').textContent = kwc ? kwc.toLocaleString('fr-FR',{minimumFractionDigits:1,maximumFractionDigits:2})+' kWc' : '‚Äî kWc';
  document.getElementById('kpi_prod').textContent = prod ? prod.toLocaleString('fr-FR')+' kWh' : '‚Äî kWh';
  document.getElementById('equip_out').textContent = kwc
    ? `‚âà ${kwc.toFixed(1)} kWc ‚Ä¢ ${n} panneaux ${modW} Wc ‚Ä¢ ${m2} m¬≤`
    : 'Saisis surface ou nb de panneaux (ou utilise ‚ÄúD√©terminer le kit‚Äù).';
  return { kwc, prod };
}

/* Conso / Autoconso */
function calcConso(){
  const {kwc,prod}=calcEquip();
  const cons = num(document.getElementById('cons').value);
  let ac = Math.max(0, Math.min(100, num(document.getElementById('ac_base').value)));
  if(batteryOn){ ac = Math.min(95, ac + (num(document.getElementById('virt_add').value)||0)); }
  if(prod>0) ac = Math.min(ac, Math.round(Math.min(100,(cons/prod)*100)));
  const surplus = Math.max(0, 100 - ac);
  const savings = (prod * (ac/100)) * num(document.getElementById('grid_p').value);
  const subYear = Math.max(0, num(document.getElementById('sub_m').value)) * 12 * (document.getElementById('isVirtual').checked ? 1 : 0);
  const netGain = (savings) - subYear; // la revente est ajout√©e dans calcAides
  document.getElementById('kpi_ac').textContent = ac.toLocaleString('fr-FR')+' %';
  document.getElementById('kpi_surplus').textContent = surplus.toLocaleString('fr-FR')+' %';
  document.getElementById('kpi_sav').textContent = euro(savings)+'/an';
  document.getElementById('kpi_net').textContent = euro(netGain)+'/an';
  document.getElementById('size_out').textContent = document.getElementById('size_out').textContent || '‚Äî';
  return {kwc, prod, ac, surplus, savings, subYear};
}

/* Dimensionnement par consommation */
function sizeFromConsumption(){
  const conso     = Math.max(0, num(document.getElementById('cons').value));
  const coverage  = Math.max(0.5, Math.min(1.2, num(document.getElementById('target_cov').value)/100)); // 50% √† 120%
  const yield0    = Math.max(500, num(document.getElementById('yield').value));
  const factor    = oriTiltFactor(document.getElementById('orient').value, document.getElementById('tilt').value);
  const modW      = Math.max(200, num(document.getElementById('mod_w').value));
  const kwc_need  = (conso * coverage) / (yield0 * factor);
  const panels    = Math.max(1, Math.round((kwc_need*1000)/modW));
  const surface   = surfaceFromPanels(panels);
  _syncLock=true;
  document.getElementById('n_pan').value = panels;
  document.getElementById('s_m2').value  = surface;
  _syncLock=false;
  calcAll();
  document.getElementById('size_out').textContent =
    `Objectif ${Math.round(coverage*100)}% ‚Üí ‚âà ${kwc_need.toFixed(1)} kWc ‚Ä¢ ${panels} panneaux ${modW} Wc ‚Ä¢ ${surface} m¬≤ (facteur orientation ${factor.toFixed(2)})`;
}

/* --- Bar√®mes officiels CRE/OA fig√©s (T2 & T3 2025) --- */
const RATES = {
  // T2 2025 : depuis l'arr√™t√© modifiant S21 (CRE ‚Äì mars 2025)
  "2025T2": {
    prime:   { p9:80,  p36:180,  p100:90 },       // ‚Ç¨/kWc
    surplus: { s9:0.040, s100:0.0731 },           // ‚Ç¨/kWh
    totale:  { v36:0.1243, v100:0.1081 }          // ‚Ç¨/kWh (‚â•9 kWc)
  },
  // T3 2025 (01/07 ‚Üí 30/09) : identique T2 selon publications CRE/OA
  "2025T3": {
    prime:   { p9:80,  p36:180,  p100:90 },
    surplus: { s9:0.040, s100:0.0731 },
    totale:  { v36:0.1243, v100:0.1081 }
  }
};

function currentRates(){
  const p = document.getElementById('period').value;
  if(p==='custom'){
    return {
      prime:{p9:num(c_p9.value),p36:num(c_p36.value),p100:num(c_p100.value)},
      surplus:{s9:num(c_s9.value),s100:num(c_s100.value)},
      totale:{v36:num(c_v36.value),v100:num(c_v100.value)}
    };
  }
  return RATES[p];
}
function renderMemo(){
  const custom = document.getElementById('period').value==='custom';
  document.getElementById('customBox').style.display = custom ? 'block':'none';
  const r = currentRates();
  const body = document.getElementById('memoBody'); body.innerHTML='';
  const rows = [
    ['Surplus','‚â§ 9 kWc', r.surplus.s9+' ‚Ç¨/kWh'],
    ['Surplus','9‚Äì100 kWc', r.surplus.s100+' ‚Ç¨/kWh'],
    ['Vente totale','9‚Äì36 kWc', r.totale.v36+' ‚Ç¨/kWh'],
    ['Vente totale','36‚Äì100 kWc', r.totale.v100+' ‚Ç¨/kWh'],
    ['Prime','‚â§ 9 kWc', r.prime.p9+' ‚Ç¨/kWc'],
    ['Prime','9‚Äì36 kWc', r.prime.p36+' ‚Ç¨/kWc'],
    ['Prime','36‚Äì100 kWc', r.prime.p100+' ‚Ç¨/kWc']
  ];
  rows.forEach(rw=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${rw[0]}</td><td>${rw[1]}</td><td>${rw[2]}</td>`; body.appendChild(tr); });
}
function primeRate(kwc,r){ if(kwc<=9) return r.prime.p9; if(kwc<=36) return r.prime.p36; if(kwc<=100) return r.prime.p100; return 0; }
function oaTarif(kwc,mode,r){
  if(mode==='surplus'){ if(kwc<=9) return r.surplus.s9; if(kwc<=100) return r.surplus.s100; return 0; }
  else{ if(kwc<9) return 0; if(kwc<=36) return r.totale.v36; if(kwc<=100) return r.totale.v100; return 0; }
}

/* calcAides : prime bas√©e sur kWc du kit, revente + net apr√®s abonnement */
function calcAides(){
  const { kwc, prod, ac, surplus, savings, subYear } = calcConso();
  const r = currentRates();
  const mode = document.getElementById('contract').value;
  const t = oaTarif(kwc, mode, r);

  // Prime : uniquement si surplus ET pas de batterie virtuelle coch√©e
  let prime = 0;
  const isVirtual = document.getElementById('isVirtual').checked;
  if (mode === 'surplus' && !isVirtual) {
    const rateP = primeRate(kwc, r);
    prime = Math.round(rateP * kwc);
  }

  // Revente annuelle
  let rev = 0;
  if (t > 0) {
    rev = mode === 'surplus' ? (prod * (surplus / 100)) * t : (prod * t);
  }

  // Gain net = √©conomies + revente - abonnement annuel (si virtuelle)
  const net = (savings + rev) - subYear;

  // Affichage
  document.getElementById('kpi_oa').textContent = t
    ? rate(t)
    : (mode === 'totale' && kwc < 9 ? 'Non √©ligible (<9 kWc)' : '‚Äî ‚Ç¨/kWh');

  document.getElementById('kpi_prime').textContent = prime ? euro(prime) : '‚Äî ‚Ç¨';
  document.getElementById('kpi_rev').textContent   = rev ? euro(rev)+'/an' : '‚Äî ‚Ç¨/an';
  document.getElementById('kpi_net').textContent   = euro(net)+'/an';

  document.getElementById('aides_out').textContent = t
    ? `Tarif OA ${rate(t)} ‚Ä¢ Prime ${prime ? euro(prime) : '‚Äî'} ‚Ä¢ Revente ‚âà ${euro(rev)}/an`
    : 'Compl√®te les blocs pr√©c√©dents.';

  // √âch√©ancier prime
  const sched = document.getElementById('primeSched');
  const tb = sched.querySelector('tbody'); tb.innerHTML = '';
  if (prime > 0) {
    if (kwc > 9) {
      const y1 = Math.round(prime * 0.80), yN = Math.round(prime * 0.05);
      [['Ann√©e 1 (~1 an)', y1], ['Ann√©e 2', yN], ['Ann√©e 3', yN], ['Ann√©e 4', yN], ['Ann√©e 5', yN]]
        .forEach(rw => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${rw[0]}</td><td style="text-align:right">${euro(rw[1])}</td>`;
          tb.appendChild(tr);
        });
    }else{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>Versement unique (~1 an)</td><td style="text-align:right">${euro(prime)}</td>`;
      tb.appendChild(tr);
    }
    sched.style.display = 'table';
  } else {
    sched.style.display = 'none';
  }
}

/* Raccourcis & orchestration */
function setYield(v){ document.getElementById('yield').value=v; calcAll(); }
function calcAll(){ calcEquip(); calcConso(); renderMemo(); }
function resetForm(){
  const defaults = {s_m2:60,n_pan:0,mod_w:400,orient:'S',tilt:30,yield:1100,cons:6000,ac_base:40,virt_add:30,grid_p:0.25,period:'2025T3',contract:'surplus',target_cov:100,sub_m:15};
  Object.entries(defaults).forEach(([k,v])=>{ const el=document.getElementById(k); if(!el) return; el.value=v; });
  document.getElementById('isVirtual').checked = true;
  batteryOn=false; document.getElementById('battOff').classList.add('active'); document.getElementById('battOn').classList.remove('active');
  document.getElementById('size_out').textContent='‚Äî';
  calcAll();
}

/* INIT */
renderMemo();
calcAll();
</script>
</body>
</html>